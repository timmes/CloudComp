<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Comp - Learning Gamification Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .tab-button {
            @apply px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors;
        }
        .tab-button.active {
            @apply bg-blue-500 text-white border-blue-500;
        }
        .scroll-table {
            max-height: 500px;
            overflow-y: auto;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-error { background-color: #ef4444; }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        @media (max-width: 768px) {
            .sort-controls {
                justify-content: center;
                margin-bottom: 1rem;
            }
        }
        /* Smooth scrolling for manual navigation */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">☁️ Cloud Comp</h1>
                    <h2 class="text-lg font-medium text-gray-700 mb-1">Learning Gamification Admin</h2>
                    <p class="text-sm text-gray-600">Manage learning activities, points, and leaderboards</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="dataStatus" class="flex items-center text-sm">
                        <div class="status-indicator status-warning"></div>
                        <span>No data loaded</span>
                    </div>
                    <button onclick="showTab('import')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                        📤 Import Data
                    </button>
                    <button onclick="exportData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                        📥 Export Data
                    </button>
                    <button onclick="showTab('manual')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                        📖 Readme
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Navigation Tabs -->
        <nav class="mb-8">
            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                <button id="dashboardTab" onclick="showTab('dashboard')" class="tab-button active">
                    📊 Dashboard
                </button>
                <button id="importTab" onclick="showTab('import')" class="tab-button">
                    📁 Import Data
                </button>
                <button id="usersTab" onclick="showTab('users')" class="tab-button">
                    👥 Users
                </button>
                <button id="teamsTab" onclick="showTab('teams')" class="tab-button">
                    🏢 Teams
                </button>
                <button id="activitiesTab" onclick="showTab('activities')" class="tab-button">
                    📚 Activities
                </button>
                <button id="configTab" onclick="showTab('config')" class="tab-button">
                    ⚙️ Configuration
                </button>
                <button id="reportsTab" onclick="showTab('reports')" class="tab-button">
                    📈 Reports
                </button>
                <button id="manualTab" onclick="showTab('manual')" class="tab-button">
                    📖 Manual
                </button>
            </div>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboardSection" class="tab-content">
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Users</p>
                            <p id="totalUsers" class="text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">👥</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Teams</p>
                            <p id="totalTeams" class="text-3xl font-bold text-teal-600">0</p>
                        </div>
                        <div class="w-12 h-12 bg-teal-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">🏢</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Completed</p>
                            <p id="completedActivities" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">✅</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">In Progress</p>
                            <p id="inProgressActivities" class="text-3xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">🔄</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Points Awarded</p>
                            <p id="totalPointsAwarded" class="text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">🎯</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">This Month</p>
                            <p id="currentMonthActivities" class="text-3xl font-bold text-indigo-600">0</p>
                        </div>
                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">📅</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Month Leaderboards -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- User Leaderboard -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">🏆 Top Users This Month</h3>
                        <button onclick="resetMonthlyLeaderboard()" class="text-sm bg-red-50 text-red-600 px-3 py-1 rounded-lg hover:bg-red-100">
                            Reset Month
                        </button>
                    </div>
                    <div class="scroll-table">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Rank</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">User</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Points</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Team Leaderboard -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">🏆 Top Teams This Month</h3>
                        <button onclick="showTab('teams')" class="text-sm bg-teal-50 text-teal-600 px-3 py-1 rounded-lg hover:bg-teal-100">
                            Manage Teams
                        </button>
                    </div>
                    <div class="scroll-table">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Rank</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Team</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Members</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Points</th>
                                </tr>
                            </thead>
                            <tbody id="teamLeaderboardBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">📈 Recent Activities</h3>
                    <div class="scroll-table">
                        <div id="recentActivities" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Charts Placeholder -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">📊 Activity Overview</h3>
                <div id="activityCharts" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>
        </div>

        <!-- Import Tab -->
        <div id="importSection" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-8 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">📁 Import Learning Data</h2>
                
                <!-- File Upload Areas -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Course Activity Files -->
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center bg-blue-50">
                        <input type="file" id="courseFiles" accept=".xlsx,.csv" multiple class="hidden">
                        <div class="mb-4">
                            <span class="text-4xl">📚</span>
                        </div>
                        <button onclick="document.getElementById('courseFiles').click()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium mb-3">
                            Choose Multiple Course Activity Files
                        </button>
                        <p class="text-sm text-gray-600 mb-2">Upload multiple Excel or CSV files with course completion data</p>
                        <div id="courseFileList" class="text-sm text-blue-600"></div>
                    </div>
                    
                    <!-- Teams Meeting Files -->
                    <div class="border-2 border-dashed border-green-300 rounded-lg p-8 text-center bg-green-50">
                        <input type="file" id="teamsFiles" accept=".csv,.xlsx" multiple class="hidden">
                        <div class="mb-4">
                            <span class="text-4xl">👥</span>
                        </div>
                        <button onclick="document.getElementById('teamsFiles').click()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium mb-3">
                            Choose Multiple Teams Meeting Files
                        </button>
                        <p class="text-sm text-gray-600 mb-2">Upload multiple CSV files with meeting attendance data</p>
                        <div id="teamsFileList" class="text-sm text-green-600"></div>
                    </div>
                </div>
                
                <!-- Process Button -->
                <div class="text-center">
                    <button id="processBtn" onclick="processAllFiles()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-lg font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" 
                            disabled>
                        🚀 Process All Files
                    </button>
                </div>
            </div>

            <!-- Import Results -->
            <div id="importResults" class="hidden bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">📊 Import Results</h3>
                <div id="importStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"></div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h4 class="font-medium mb-2">Processing Log</h4>
                    <div id="importLog" class="bg-white p-3 rounded font-mono text-sm h-64 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="usersSection" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">👥 User Management</h2>
                    <div class="flex items-center space-x-4 flex-wrap">
                        <div class="sort-controls">
                            <span class="text-sm text-gray-600">Sort by:</span>
                            <button onclick="toggleUserSort('currentMonthPoints')" 
                                    class="px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                                    id="sortCurrentMonth">
                                This Month 📊
                            </button>
                            <button onclick="toggleUserSort('totalPoints')" 
                                    class="px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                                    id="sortTotal">
                                Total Points 🎯
                            </button>
                            <button onclick="toggleUserSortOrder()" 
                                    class="px-3 py-1 text-xs rounded-lg bg-blue-100 text-blue-800 border border-blue-300 hover:bg-blue-200 transition-colors"
                                    id="sortOrderUser">
                                Most First ⬇️
                            </button>
                        </div>
                        <input type="text" id="userSearch" placeholder="Search users..." 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onkeyup="filterUsers()">
                        <button onclick="addManualPoints()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            ➕ Add Points
                        </button>
                    </div>
                </div>
                
                <!-- Bulk Actions Bar -->
                <div id="userBulkActions" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium text-blue-900">
                                <span id="selectedUsersCount">0</span> users selected
                            </span>
                            <button onclick="selectAllUsers()" class="text-sm text-blue-600 hover:text-blue-800">
                                Select All
                            </button>
                            <button onclick="deselectAllUsers()" class="text-sm text-blue-600 hover:text-blue-800">
                                Clear Selection
                            </button>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="bulkAwardPoints()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                                🎁 Award Points
                            </button>
                            <button onclick="bulkAssignTeam()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg text-sm">
                                🏢 Assign to Team
                            </button>
                            <button onclick="bulkExportUsers()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                                📥 Export Selected
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="scroll-table">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left">
                                    <input type="checkbox" id="selectAllUsersCheckbox" onclick="toggleSelectAllUsers()" class="rounded">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">User</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Current Month</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Total Points</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Activities</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Last Activity</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Teams Tab -->
        <div id="teamsSection" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">🏢 Team Management</h2>
                    <div class="flex items-center space-x-4 flex-wrap">
                        <div class="sort-controls">
                            <span class="text-sm text-gray-600">Sort by:</span>
                            <button onclick="toggleTeamSort('members')" 
                                    class="px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                                    id="sortMembers">
                                Members 👥
                            </button>
                            <button onclick="toggleTeamSort('currentMonthPoints')" 
                                    class="px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                                    id="sortTeamCurrentMonth">
                                This Month 📊
                            </button>
                            <button onclick="toggleTeamSort('totalPoints')" 
                                    class="px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                                    id="sortTeamTotal">
                                Total Points 🎯
                            </button>
                            <button onclick="toggleTeamSortOrder()" 
                                    class="px-3 py-1 text-xs rounded-lg bg-blue-100 text-blue-800 border border-blue-300 hover:bg-blue-200 transition-colors"
                                    id="sortOrderTeam">
                                Most First ⬇️
                            </button>
                        </div>
                        <input type="text" id="teamSearch" placeholder="Search teams..." 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                               onkeyup="filterTeams()">
                        <button onclick="openCreateTeamModal()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg">
                            ➕ Create Team
                        </button>
                    </div>
                </div>
                
                <div class="scroll-table">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Team Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Members</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Current Month</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Total Points</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Created</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teamsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="activitiesSection" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">📚 Activity Management</h2>
                    <div class="flex items-center space-x-4 flex-wrap">
                        <div class="sort-controls">
                            <span class="text-sm text-gray-600">Sort by:</span>
                            <button onclick="toggleActivitySort('pointsEarned')" 
                                    class="px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                                    id="sortPoints">
                                Points 🎯
                            </button>
                            <button onclick="toggleActivitySort('completedDate')" 
                                    class="px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                                    id="sortDate">
                                Date 📅
                            </button>
                            <button onclick="toggleActivitySortOrder()" 
                                    class="px-3 py-1 text-xs rounded-lg bg-blue-100 text-blue-800 border border-blue-300 hover:bg-blue-200 transition-colors"
                                    id="sortOrderActivity">
                                Most/Recent First ⬇️
                            </button>
                        </div>
                        <select id="activityFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterActivities()">
                            <option value="all">All Activities</option>
                            <option value="current-month">Current Month</option>
                            <option value="courses">Courses Only</option>
                            <option value="events">Events Only</option>
                        </select>
                        <input type="text" id="activitySearch" placeholder="Search activities..." 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onkeyup="filterActivities()">
                    </div>
                </div>
                
                <!-- Bulk Actions Bar -->
                <div id="activityBulkActions" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium text-purple-900">
                                <span id="selectedActivitiesCount">0</span> activities selected
                            </span>
                            <button onclick="selectAllActivities()" class="text-sm text-purple-600 hover:text-purple-800">
                                Select All
                            </button>
                            <button onclick="deselectAllActivities()" class="text-sm text-purple-600 hover:text-purple-800">
                                Clear Selection
                            </button>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="bulkAdjustPoints()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm">
                                ✏️ Adjust Points
                            </button>
                            <button onclick="bulkDeleteActivities()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                                🗑️ Delete Selected
                            </button>
                            <button onclick="bulkExportActivities()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                                📥 Export Selected
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="scroll-table">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left">
                                    <input type="checkbox" id="selectAllActivitiesCheckbox" onclick="toggleSelectAllActivities()" class="rounded">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">User</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Activity</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Level</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Points</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Source</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activitiesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="configSection" class="tab-content hidden">
            <!-- Point Configuration (same as POC but enhanced) -->
            <div class="bg-white rounded-xl shadow-sm p-8 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">⚙️ Point Configuration</h2>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-medium text-blue-900 mb-2">💡 Configuration Guide</h4>
                    <p class="text-sm text-blue-800">
                        Configure points for specific course types and activities. Changes are automatically saved and applied to future imports.
                    </p>
                </div>

                <!-- AWS Course Types -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">🔧 AWS Course Types</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AWS Builder Lab</label>
                            <input type="number" id="awsBuilderLab" value="100" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AWS Cloud Quest</label>
                            <input type="number" id="awsCloudQuest" value="75" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AWS Jam Journey</label>
                            <input type="number" id="awsJamJourney" value="150" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AWS Simulearn</label>
                            <input type="number" id="awsSimulearn" value="75" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Certification Exam Preparation</label>
                            <input type="number" id="certExamPrep" value="100" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Digital Course With Lab</label>
                            <input type="number" id="digitalCourseWithLab" value="100" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                    </div>
                </div>

                <!-- General Course Categories -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">📚 General Course Categories</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Classroom Training</label>
                            <input type="number" id="classroomTraining" value="100" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Digital Courses - Foundational</label>
                            <input type="number" id="digitalFoundational" value="50" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Digital Courses - Associate</label>
                            <input type="number" id="digitalAssociate" value="75" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Digital Courses - Professional</label>
                            <input type="number" id="digitalProfessional" value="100" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Digital Courses - Specialty</label>
                            <input type="number" id="digitalSpecialty" value="100" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                    </div>
                </div>

                <!-- Events and Activities -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Events -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">🎉 Events</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Live Events</label>
                            <input type="number" id="liveEvents" value="25" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                    </div>

                    <!-- Quizzes -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">🧠 Quizzes</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Completion</label>
                                <input type="number" id="quizCompletion" value="20" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                       onchange="updatePointConfig()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quiz 80%+ Score</label>
                                <input type="number" id="quiz80Plus" value="50" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                       onchange="updatePointConfig()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Perfect Score</label>
                                <input type="number" id="quizPerfect" value="70" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                       onchange="updatePointConfig()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hackathons -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">🏆 Hackathons</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Participation</label>
                            <input type="number" id="hackathonParticipation" value="150" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">3rd Place</label>
                            <input type="number" id="hackathon3rd" value="250" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">2nd Place</label>
                            <input type="number" id="hackathon2nd" value="350" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">1st Place</label>
                            <input type="number" id="hackathon1st" value="450" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onchange="updatePointConfig()">
                        </div>
                    </div>
                </div>

                <!-- Configuration Actions -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-900">Configuration Management</h4>
                            <p class="text-sm text-gray-600">Save, reset, or export your point configuration</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="resetToDefaults()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                🔄 Reset Defaults
                            </button>
                            <button onclick="exportConfig()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                📥 Export Config
                            </button>
                            <button onclick="saveConfiguration()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                                💾 Save Changes
                            </button>
                        </div>
                    </div>
                    <div id="configStatus" class="mt-2 text-sm text-green-600"></div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsSection" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Export Options -->
                <div class="bg-white rounded-xl shadow-sm p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">📈 Reports & Export</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <button onclick="generateLeaderboardReport()" class="bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg text-center">
                            <div class="text-2xl mb-2">🏆</div>
                            <div class="font-medium">Leaderboard Report</div>
                            <div class="text-sm opacity-90">Current month rankings</div>
                        </button>
                        <button onclick="generateActivityReport()" class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg text-center">
                            <div class="text-2xl mb-2">📊</div>
                            <div class="font-medium">Activity Report</div>
                            <div class="text-sm opacity-90">All user activities</div>
                        </button>
                        <button onclick="generateSummaryReport()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-center">
                            <div class="text-2xl mb-2">📋</div>
                            <div class="font-medium">Summary Report</div>
                            <div class="text-sm opacity-90">Overall statistics</div>
                        </button>
                    </div>
                </div>

                <!-- Monthly Reset -->
                <div class="bg-white rounded-xl shadow-sm p-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">📅 Monthly Reset</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-800">
                            <strong>Warning:</strong> This will reset all current month points and create a backup of the current leaderboard.
                        </p>
                    </div>
                    <button onclick="confirmMonthlyReset()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg">
                        🔄 Reset Monthly Leaderboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Manual Tab -->
        <div id="manualSection" class="tab-content hidden">
            <div class="max-w-4xl mx-auto">
                <!-- Manual Header -->
                <div class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">📖 Cloud Comp User Manual</h1>
                    <p class="text-lg text-gray-600">Complete guide to using the Learning Gamification Platform</p>
                </div>

                <!-- Table of Contents -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">📑 Table of Contents</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a href="#getting-started" onclick="scrollToSection(event, 'getting-started')" class="text-blue-600 hover:text-blue-800">1. Getting Started</a>
                        <a href="#dashboard" onclick="scrollToSection(event, 'dashboard')" class="text-blue-600 hover:text-blue-800">2. Dashboard Overview</a>
                        <a href="#importing" onclick="scrollToSection(event, 'importing')" class="text-blue-600 hover:text-blue-800">3. Importing Data</a>
                        <a href="#users" onclick="scrollToSection(event, 'users')" class="text-blue-600 hover:text-blue-800">4. Managing Users</a>
                        <a href="#teams" onclick="scrollToSection(event, 'teams')" class="text-blue-600 hover:text-blue-800">5. Managing Teams</a>
                        <a href="#activities" onclick="scrollToSection(event, 'activities')" class="text-blue-600 hover:text-blue-800">6. Managing Activities</a>
                        <a href="#configuration" onclick="scrollToSection(event, 'configuration')" class="text-blue-600 hover:text-blue-800">7. Point Configuration</a>
                        <a href="#reports" onclick="scrollToSection(event, 'reports')" class="text-blue-600 hover:text-blue-800">8. Reports & Exports</a>
                        <a href="#tips" onclick="scrollToSection(event, 'tips')" class="text-blue-600 hover:text-blue-800">9. Tips & Best Practices</a>
                        <a href="#troubleshooting" onclick="scrollToSection(event, 'troubleshooting')" class="text-blue-600 hover:text-blue-800">10. Troubleshooting</a>
                    </div>
                </div>

                <!-- Getting Started -->
                <div id="getting-started" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">🚀 1. Getting Started</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">System Requirements</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li>Modern web browser (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)</li>
                                <li>JavaScript enabled</li>
                                <li>Local storage enabled (for data persistence)</li>
                                <li>No server or installation required</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">First Time Setup</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Open <code class="bg-gray-100 px-2 py-1 rounded">cloud_comp_app.html</code> in your browser</li>
                                <li>The application will automatically initialize with empty data</li>
                                <li>Start by importing existing data or creating teams manually</li>
                                <li>Data automatically saves to your browser's local storage</li>
                            </ol>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <strong>💡 Tip:</strong> Bookmark the application for quick access. All your data persists between sessions.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Overview -->
                <div id="dashboard" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">📊 2. Dashboard Overview</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Key Metrics</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                                <div><strong>Total Users:</strong> Number of registered learners</div>
                                <div><strong>Total Teams:</strong> Number of created teams</div>
                                <div><strong>Completed:</strong> Total completed activities</div>
                                <div><strong>In Progress:</strong> Activities currently being worked on</div>
                                <div><strong>Points Awarded:</strong> Total points across all users</div>
                                <div><strong>This Month:</strong> Activities completed this month</div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Leaderboards</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><strong>User Leaderboard:</strong> Top 10 individual performers for the current month</li>
                                <li><strong>Team Leaderboard:</strong> Top 5 teams based on combined member points</li>
                                <li>Both leaderboards reset monthly (with archive option)</li>
                                <li>Medals (🥇🥈🥉) displayed for top 3 positions</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Recent Activities</h3>
                            <p class="text-gray-700">Shows the 10 most recent completed activities with user, title, date, and points earned.</p>
                        </div>
                    </div>
                </div>

                <!-- Importing Data -->
                <div id="importing" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">📁 3. Importing Data</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Course Activity Files</h3>
                            <div class="bg-gray-50 rounded-lg p-4 mb-3">
                                <p class="font-medium text-gray-900 mb-2">Required Columns:</p>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                    <li>Email - User's email address</li>
                                    <li>Course ID - Unique course identifier</li>
                                    <li>Course Title - Name of the course</li>
                                    <li>Status - COMPLETED or IN PROGRESS</li>
                                    <li>Level - fundamental/intermediate/advanced/specialty</li>
                                    <li>CourseType - AWS Cloud Quest, Digital Course, etc.</li>
                                    <li>Completed on - Completion date (for completed courses)</li>
                                    <li>Score (optional) - For quiz scoring</li>
                                </ul>
                            </div>
                            <p class="text-gray-700">Supports Excel (.xlsx) and CSV formats. Multiple files can be processed at once.</p>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Teams Meeting Files</h3>
                            <div class="bg-gray-50 rounded-lg p-4 mb-3">
                                <p class="font-medium text-gray-900 mb-2">Expected Format:</p>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                    <li>Meeting title or Meeting Title field</li>
                                    <li>Attended participants count</li>
                                    <li>Individual attendee emails (optional)</li>
                                    <li>Each attendee receives 25 points per meeting</li>
                                </ul>
                            </div>
                            <p class="text-gray-700">CSV format from Microsoft Teams exports. System creates placeholder emails if not found.</p>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Import Process</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Go to the Import Data tab</li>
                                <li>Click "Choose Multiple Course Activity Files" or "Choose Multiple Teams Meeting Files"</li>
                                <li>Select one or more files from your computer</li>
                                <li>Click "🚀 Process All Files"</li>
                                <li>Review the import log for any issues</li>
                                <li>Check the dashboard for updated statistics</li>
                            </ol>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">
                                <strong>⚠️ Note:</strong> The system automatically skips duplicate entries based on email + course/meeting ID.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Managing Users -->
                <div id="users" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">👥 4. Managing Users</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">User Overview</h3>
                            <p class="text-gray-700 mb-3">Users are automatically created when importing activity data. Each user has:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                <li>Email (primary identifier)</li>
                                <li>Name (from import data)</li>
                                <li>Current month points</li>
                                <li>Total all-time points</li>
                                <li>Activity count</li>
                                <li>Team assignment (if applicable)</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">User Management Features</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><strong>Search:</strong> Find users by name or email</li>
                                <li><strong>Sort:</strong> By current month or total points</li>
                                <li><strong>Manual Points:</strong> Award custom points for special achievements</li>
                                <li><strong>Bulk Operations:</strong> Select multiple users to award points, assign to teams, or export</li>
                                <li><strong>View Details:</strong> See individual user activity history (coming soon)</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Bulk Operations</h3>
                            <p class="text-gray-700 mb-3">Select multiple users for efficient bulk actions:</p>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Click checkboxes next to users or use "Select All"</li>
                                <li>The bulk actions bar appears when users are selected</li>
                                <li>Choose from: Award Points, Assign to Team, or Export Selected</li>
                                <li>Fill in the required information in the modal</li>
                                <li>Confirm the bulk action</li>
                            </ol>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Adding Manual Points</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Click "➕ Add Points" in the Users tab</li>
                                <li>Enter the user's email address</li>
                                <li>Provide an activity title</li>
                                <li>Set the point value</li>
                                <li>Add a description (optional)</li>
                                <li>Click "Add Points" to award</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Managing Teams -->
                <div id="teams" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">🏢 5. Managing Teams</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Creating Teams</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Navigate to the Teams tab</li>
                                <li>Click "➕ Create Team"</li>
                                <li>Enter team name and description</li>
                                <li>Choose a team color (8 options available)</li>
                                <li>Click "Create Team"</li>
                            </ol>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Managing Team Members</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Click "Manage" on any team</li>
                                <li>Select users from the available list (Ctrl/Cmd for multiple)</li>
                                <li>Click "Add →" to add members</li>
                                <li>Click "Remove" next to any member to remove them</li>
                                <li>Team points automatically update based on member totals</li>
                            </ol>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Team Features</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><strong>Color Coding:</strong> Visual identification with 8 color options</li>
                                <li><strong>Automatic Points:</strong> Team points = sum of all member points</li>
                                <li><strong>Sorting:</strong> Sort by members, current month points, or total points</li>
                                <li><strong>Search:</strong> Find teams quickly by name or description</li>
                                <li><strong>Delete:</strong> Remove teams (members remain as users)</li>
                                <li><strong>Leaderboard:</strong> Teams compete on the dashboard</li>
                            </ul>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-sm text-green-800">
                                <strong>💡 Tip:</strong> Teams are great for departments, project groups, or learning cohorts.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Managing Activities -->
                <div id="activities" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">📚 6. Managing Activities</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Activity Types</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                                <div>
                                    <strong>Courses:</strong>
                                    <ul class="list-disc list-inside text-sm mt-1 ml-4">
                                        <li>Digital courses (50-100 points)</li>
                                        <li>Classroom training (100 points)</li>
                                        <li>AWS specialized courses</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>Events:</strong>
                                    <ul class="list-disc list-inside text-sm mt-1 ml-4">
                                        <li>Teams meetings (25 points)</li>
                                        <li>Live events (25 points)</li>
                                        <li>Hackathons (150-450 points)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Activity Management Features</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><strong>Sort:</strong> By points earned or completion date</li>
                                <li><strong>Filter:</strong> Current month, courses only, or events only</li>
                                <li><strong>Search:</strong> Find activities by user or title</li>
                                <li><strong>Bulk Operations:</strong> Select multiple activities to adjust points, delete, or export</li>
                                <li><strong>Edit:</strong> Modify activity details (coming soon)</li>
                                <li><strong>Source Tracking:</strong> See which import file created each activity</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Bulk Activity Operations</h3>
                            <p class="text-gray-700 mb-3">Manage multiple activities efficiently:</p>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><strong>Adjust Points:</strong> Add, subtract, multiply, or set new point values</li>
                                <li><strong>Delete Selected:</strong> Remove multiple activities at once</li>
                                <li><strong>Export Selected:</strong> Export specific activities to JSON</li>
                                <li><strong>Adjustment History:</strong> All point changes are tracked with reasons</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">In-Progress Activities</h3>
                            <p class="text-gray-700">The system tracks activities with "IN PROGRESS" status separately. These:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-700 mt-2">
                                <li>Don't award points until completed</li>
                                <li>Show progress percentage when available</li>
                                <li>Automatically convert to completed when re-imported with COMPLETED status</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Point Configuration -->
                <div id="configuration" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">⚙️ 7. Point Configuration</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Default Point Values</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Activity Type</th>
                                            <th class="px-4 py-2 text-left">Points</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <tr><td class="px-4 py-2">Digital Course - Foundational</td><td class="px-4 py-2">50</td></tr>
                                        <tr><td class="px-4 py-2">Digital Course - Associate</td><td class="px-4 py-2">75</td></tr>
                                        <tr><td class="px-4 py-2">Digital Course - Professional</td><td class="px-4 py-2">100</td></tr>
                                        <tr><td class="px-4 py-2">AWS Cloud Quest</td><td class="px-4 py-2">75</td></tr>
                                        <tr><td class="px-4 py-2">AWS Builder Lab</td><td class="px-4 py-2">100</td></tr>
                                        <tr><td class="px-4 py-2">Teams Meeting / Live Event</td><td class="px-4 py-2">25</td></tr>
                                        <tr><td class="px-4 py-2">Hackathon Participation</td><td class="px-4 py-2">150</td></tr>
                                        <tr><td class="px-4 py-2">Quiz (based on score)</td><td class="px-4 py-2">20-70</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Customizing Points</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Go to the Configuration tab</li>
                                <li>Adjust point values for each activity type</li>
                                <li>Click "💾 Save Changes" to apply</li>
                                <li>New imports will use updated values</li>
                                <li>Existing activities keep their original points</li>
                            </ol>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Configuration Management</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><strong>Reset Defaults:</strong> Restore original point values</li>
                                <li><strong>Export Config:</strong> Save configuration as JSON</li>
                                <li><strong>Auto-save:</strong> Changes persist in browser storage</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Reports & Exports -->
                <div id="reports" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">📈 8. Reports & Exports</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Available Reports</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><strong>Leaderboard Report:</strong> Current month user rankings with points</li>
                                <li><strong>Activity Report:</strong> Complete list of all activities with details</li>
                                <li><strong>Summary Report:</strong> Overall statistics, top users, and top teams</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Data Export</h3>
                            <p class="text-gray-700 mb-3">Click "📥 Export Data" in the header to create a complete backup including:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                <li>All users and their points</li>
                                <li>All teams and memberships</li>
                                <li>All activities (completed and in-progress)</li>
                                <li>Configuration settings</li>
                                <li>Metadata and statistics</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Monthly Reset</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Go to Reports tab</li>
                                <li>Click "🔄 Reset Monthly Leaderboard"</li>
                                <li>Confirm the action</li>
                                <li>System creates an archive of current standings</li>
                                <li>All current month points reset to 0</li>
                                <li>Total points remain unchanged</li>
                            </ol>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <strong>💡 Tip:</strong> Export data regularly as a backup. Files are timestamped for easy organization.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tips & Best Practices -->
                <div id="tips" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">💡 9. Tips & Best Practices</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Daily Usage</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li>Import new activity data weekly or bi-weekly</li>
                                <li>Check dashboard for quick performance overview</li>
                                <li>Award manual points for special achievements immediately</li>
                                <li>Keep team memberships current</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Monthly Tasks</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li>Generate and share leaderboard reports</li>
                                <li>Reset monthly points after announcing winners</li>
                                <li>Review and adjust point configurations if needed</li>
                                <li>Export full data backup</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Data Management</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li>Keep source files organized by date</li>
                                <li>Name import files descriptively</li>
                                <li>Regular exports protect against data loss</li>
                                <li>Browser storage persists unless manually cleared</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Team Management</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li>Create teams before bulk user imports</li>
                                <li>Use consistent team names</li>
                                <li>Color-code teams by department or function</li>
                                <li>Review team compositions quarterly</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Troubleshooting -->
                <div id="troubleshooting" class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">🔧 10. Troubleshooting</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Common Issues</h3>
                            
                            <div class="space-y-4">
                                <div class="border-l-4 border-gray-300 pl-4">
                                    <p class="font-medium text-gray-900">Data not saving</p>
                                    <p class="text-gray-700 text-sm">Check browser settings → Privacy → ensure localStorage is enabled</p>
                                </div>
                                
                                <div class="border-l-4 border-gray-300 pl-4">
                                    <p class="font-medium text-gray-900">Import not working</p>
                                    <p class="text-gray-700 text-sm">Verify file has required columns (Email, Course ID, Title, Status)</p>
                                </div>
                                
                                <div class="border-l-4 border-gray-300 pl-4">
                                    <p class="font-medium text-gray-900">Points not calculating correctly</p>
                                    <p class="text-gray-700 text-sm">Check Configuration tab settings and save changes</p>
                                </div>
                                
                                <div class="border-l-4 border-gray-300 pl-4">
                                    <p class="font-medium text-gray-900">Teams not showing points</p>
                                    <p class="text-gray-700 text-sm">Ensure team has members assigned through Manage option</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Data Recovery</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Check browser console (F12) for error messages</li>
                                <li>Try importing a recent backup JSON file</li>
                                <li>localStorage persists unless manually cleared</li>
                                <li>Browser cache clearing does NOT affect localStorage</li>
                            </ol>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Browser Compatibility</h3>
                            <p class="text-gray-700 mb-2">For best results use:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                <li>Chrome 90 or newer (recommended)</li>
                                <li>Firefox 88 or newer</li>
                                <li>Safari 14 or newer</li>
                                <li>Edge 90 or newer</li>
                            </ul>
                        </div>

                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-sm text-red-800">
                                <strong>⚠️ Important:</strong> Never clear browser data without exporting a backup first. 
                                Clearing site data will permanently delete all stored information.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Support -->
                <div class="bg-white rounded-xl shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">📞 Support & Credits</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Getting Help</h3>
                            <p class="text-gray-700">For additional support or feature requests, contact your system administrator or the development team.</p>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Version Information</h3>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                <li>Current Version: 1.1</li>
                                <li>Last Updated: August 2025</li>
                                <li>File: cloud_comp_app.html</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Credits</h3>
                            <p class="text-gray-700">
                                Created with love and the help of Claude Sonnet 4 by 
                                <strong>@timhutte</strong> and <strong>@gmmarrs</strong>
                            </p>
                        </div>

                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <p class="text-sm text-purple-800">
                                <strong>🎉 Thank you</strong> for using Cloud Comp! 
                                Your commitment to learning and development makes our organization stronger.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t mt-16">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="text-center">
                <p class="text-sm text-gray-600">
                    Created with love and the help of Claude Sonnet 4 by 
                    <span class="font-medium text-gray-800">@timhutte</span> and 
                    <span class="font-medium text-gray-800">@gmmarrs</span>
                </p>
            </div>
        </div>
    </footer>

    <!-- Import Data Modal -->
    <div id="importDataModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">📤 Import Data</h3>
            <p class="text-sm text-gray-600 mb-4">Import a previously exported cloud_comp_data_*.json file to restore your data.</p>
            <div class="space-y-4">
                <div>
                    <input type="file" id="importDataFile" accept=".json" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeImportDataModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="processImportData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Import</button>
            </div>
        </div>
    </div>

    <!-- Add Points Modal -->
    <div id="addPointsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">➕ Add Manual Points</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User Email</label>
                    <input type="email" id="manualUserEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="user@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Activity Title</label>
                    <input type="text" id="manualActivityTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Manual Award">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Points</label>
                    <input type="number" id="manualPoints" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="manualDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="Reason for award..."></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddPointsModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="submitManualPoints()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Add Points</button>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div id="createTeamModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">🏢 Create New Team</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Team Name</label>
                    <input type="text" id="teamName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Engineering Team">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="teamDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="Team description..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Team Color</label>
                    <select id="teamColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                        <option value="pink">Pink</option>
                        <option value="teal">Teal</option>
                        <option value="indigo">Indigo</option>
                        <option value="red">Red</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeCreateTeamModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="createTeam()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg">Create Team</button>
            </div>
        </div>
    </div>

    <!-- Manage Team Members Modal -->
    <div id="manageTeamMembersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">👥 Manage Team Members</h3>
            <div class="mb-4">
                <h4 id="managingTeamName" class="font-medium text-gray-900"></h4>
                <p id="managingTeamDescription" class="text-sm text-gray-600"></p>
            </div>
            
            <!-- Add Members Section -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h5 class="font-medium mb-3">Add Members</h5>
                <div class="flex space-x-2">
                    <select id="availableUsers" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" multiple size="5">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <button onclick="addUsersToTeam()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg">
                        Add →
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Hold Ctrl/Cmd to select multiple users</p>
            </div>
            
            <!-- Current Members Section -->
            <div class="bg-white border rounded-lg p-4">
                <h5 class="font-medium mb-3">Current Members</h5>
                <div id="teamMembersList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Members will be listed here -->
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeManageTeamMembersModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Close</button>
            </div>
        </div>
    </div>

    <!-- Bulk Award Points Modal -->
    <div id="bulkAwardPointsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">🎁 Bulk Award Points</h3>
            <p class="text-sm text-gray-600 mb-4">Award points to <span id="bulkAwardUserCount" class="font-bold">0</span> selected users</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Activity Title</label>
                    <input type="text" id="bulkActivityTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Bulk Award">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Points per User</label>
                    <input type="number" id="bulkPoints" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="bulkDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="Reason for bulk award..."></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeBulkAwardPointsModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="submitBulkAwardPoints()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Award Points</button>
            </div>
        </div>
    </div>

    <!-- Bulk Assign Team Modal -->
    <div id="bulkAssignTeamModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">🏢 Bulk Assign to Team</h3>
            <p class="text-sm text-gray-600 mb-4">Assign <span id="bulkAssignUserCount" class="font-bold">0</span> selected users to a team</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Team</label>
                    <select id="bulkTeamSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">Choose a team...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeBulkAssignTeamModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="submitBulkAssignTeam()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg">Assign to Team</button>
            </div>
        </div>
    </div>

    <!-- Bulk Adjust Points Modal -->
    <div id="bulkAdjustPointsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">✏️ Bulk Adjust Points</h3>
            <p class="text-sm text-gray-600 mb-4">Adjust points for <span id="bulkAdjustActivityCount" class="font-bold">0</span> selected activities</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adjustment Type</label>
                    <select id="bulkAdjustType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="add">Add Points</option>
                        <option value="subtract">Subtract Points</option>
                        <option value="multiply">Multiply by Factor</option>
                        <option value="set">Set to Value</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                    <input type="number" id="bulkAdjustValue" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter value">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                    <textarea id="bulkAdjustReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2" placeholder="Reason for adjustment..."></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeBulkAdjustPointsModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="submitBulkAdjustPoints()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg">Adjust Points</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appData = {
            users: new Map(),
            activities: [],
            inProgressActivities: [],
            teams: new Map(), // NEW: Team management
            config: {
                pointConfig: {
                    awsCourseTypes: {
                        'AWS Builder Lab': 100,
                        'AWS Cloud Quest': 75,
                        'AWS Jam Journey': 150,
                        'AWS Simulearn': 75,
                        'Certification Exam Preparation': 100,
                        'Digital Course With Lab': 100
                    },
                    generalCourses: {
                        'Classroom Training': 100,
                        'Digital Courses - Foundational': 50,
                        'Digital Courses - Associate': 75,
                        'Digital Courses - Professional': 100,
                        'Digital Courses - Specialty': 100
                    },
                    events: {
                        'Live Events': 25
                    },
                    hackathons: {
                        'Hackathons - Participation': 150,
                        'Hackathons - 3rd Place': 250,
                        'Hackathons - 2nd Place': 350,
                        'Hackathons - 1st Place': 450
                    },
                    quizzes: {
                        'Quiz Completion': 20,
                        'Quiz 80%+ Score': 50,
                        'Quiz Perfect Score': 70
                    }
                },
                lastReset: new Date().toISOString().slice(0, 7),
                version: '1.1'
            },
            metadata: {
                lastImport: null,
                totalRecordsProcessed: 0,
                sources: []
            }
        };

        let selectedFiles = {
            course: [],
            teams: []
        };

        // Bulk selection tracking
        let bulkSelection = {
            users: new Set(),
            activities: new Set()
        };

        // Sort state management
        let sortState = {
            users: {
                field: 'currentMonthPoints',
                ascending: false // false = most points first (descending)
            },
            activities: {
                field: 'pointsEarned',
                ascending: false // false = most points first (descending)
            },
            teams: {
                field: 'currentMonthPoints',
                ascending: false // false = most points first (descending)
            }
        };

        // Utility functions
        function log(message) {
            const logElement = document.getElementById('importLog');
            if (logElement) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                logElement.innerHTML += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            console.log(message);
        }

        function getCurrentMonth() {
            return new Date().toISOString().slice(0, 7);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString();
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        // Smooth scroll for manual navigation
        function scrollToSection(event, sectionId) {
            event.preventDefault();
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Data management - Fixed to use localStorage for persistence
        async function loadData() {
            try {
                // Try to load from localStorage first (primary persistence)
                const localData = localStorage.getItem('cloudCompData');
                if (localData) {
                    const data = JSON.parse(localData);
                    if (data.users) {
                        appData.users = new Map(Object.entries(data.users));
                    }
                    if (data.activities) {
                        appData.activities = data.activities;
                    }
                    if (data.inProgressActivities) {
                        appData.inProgressActivities = data.inProgressActivities;
                    }
                    if (data.teams) { // Load teams
                        appData.teams = new Map(Object.entries(data.teams));
                    }
                    if (data.config) {
                        appData.config = { ...appData.config, ...data.config };
                    }
                    if (data.metadata) {
                        appData.metadata = { ...appData.metadata, ...data.metadata };
                    }
                    
                    updateDataStatus('success', `Data loaded: ${appData.users.size} users, ${appData.teams.size} teams, ${appData.activities.length} activities`);
                    loadConfiguration();
                    refreshDashboard();
                    log('✅ Data loaded successfully from browser storage');
                    return;
                }
                
                // If no localStorage data, show empty state
                updateDataStatus('warning', 'No existing data found - ready for first import');
                log('ℹ️ No existing data found, starting with empty dataset');
                
            } catch (error) {
                updateDataStatus('error', 'Error loading data');
                log(`❌ Error loading data: ${error.message}`);
            }
        }

        async function saveData() {
            try {
                const dataToSave = {
                    users: Object.fromEntries(appData.users),
                    activities: appData.activities,
                    inProgressActivities: appData.inProgressActivities,
                    teams: Object.fromEntries(appData.teams), // Save teams
                    config: appData.config,
                    metadata: {
                        ...appData.metadata,
                        lastSaved: new Date().toISOString()
                    }
                };

                // Save to localStorage (primary persistence)
                localStorage.setItem('cloudCompData', JSON.stringify(dataToSave));
                
                updateDataStatus('success', `Data saved: ${appData.users.size} users, ${appData.teams.size} teams`);
                log('💾 Data auto-saved to browser storage');
                
                return true;
            } catch (error) {
                log(`❌ Error saving data: ${error.message}`);
                updateDataStatus('error', 'Failed to save data');
                return false;
            }
        }

        // Auto-save function - saves data after any changes
        async function autoSave() {
            await saveData();
        }

        // Export data to JSON file
        function exportData() {
            try {
                const dataToExport = {
                    users: Object.fromEntries(appData.users),
                    activities: appData.activities,
                    inProgressActivities: appData.inProgressActivities,
                    teams: Object.fromEntries(appData.teams), // Export teams
                    config: appData.config,
                    metadata: {
                        ...appData.metadata,
                        exportedDate: new Date().toISOString()
                    }
                };
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                downloadJSON(dataToExport, `cloud_comp_data_${timestamp}.json`);
                log('📥 Data exported to JSON file');
            } catch (error) {
                log(`❌ Error exporting data: ${error.message}`);
                alert('Error exporting data. Please try again.');
            }
        }

        // Import data from JSON file
        function importData() {
            document.getElementById('importDataModal').classList.remove('hidden');
        }

        function closeImportDataModal() {
            document.getElementById('importDataModal').classList.add('hidden');
            document.getElementById('importDataFile').value = '';
        }

        function processImportData() {
            const fileInput = document.getElementById('importDataFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a JSON file to import');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!importedData.users || !importedData.activities) {
                        alert('Invalid data file format. Please select a valid cloud_comp_data_*.json file.');
                        return;
                    }
                    
                    // Confirm import
                    const inProgressCount = importedData.inProgressActivities ? importedData.inProgressActivities.length : 0;
                    const teamsCount = importedData.teams ? Object.keys(importedData.teams).length : 0;
                    const confirmMessage = `This will replace all current data with the imported data.\n\nImported data contains:\n- ${Object.keys(importedData.users).length} users\n- ${teamsCount} teams\n- ${importedData.activities.length} completed activities\n- ${inProgressCount} in-progress activities\n\nContinue?`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // Import the data
                    if (importedData.users) {
                        appData.users = new Map(Object.entries(importedData.users));
                    }
                    if (importedData.activities) {
                        appData.activities = importedData.activities;
                    }
                    if (importedData.inProgressActivities) {
                        appData.inProgressActivities = importedData.inProgressActivities;
                    } else {
                        appData.inProgressActivities = []; // Initialize if not present in import
                    }
                    if (importedData.teams) {
                        appData.teams = new Map(Object.entries(importedData.teams));
                    } else {
                        appData.teams = new Map(); // Initialize if not present
                    }
                    if (importedData.config) {
                        appData.config = { ...appData.config, ...importedData.config };
                    }
                    if (importedData.metadata) {
                        appData.metadata = { ...appData.metadata, ...importedData.metadata };
                    }
                    
                    // Save to localStorage and update UI
                    autoSave();
                    loadConfiguration();
                    refreshDashboard();
                    refreshUsersTable();
                    refreshActivitiesTable();
                    refreshTeamsTable();
                    
                    closeImportDataModal();
                    log(`✅ Data imported successfully: ${appData.users.size} users, ${appData.teams.size} teams, ${appData.activities.length} completed`);
                    
                } catch (error) {
                    alert(`Error importing data: ${error.message}`);
                    log(`❌ Error importing data: ${error.message}`);
                }
            };
            
            reader.readAsText(file);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateDataStatus(type, message) {
            const statusElement = document.getElementById('dataStatus');
            const indicator = statusElement.querySelector('.status-indicator');
            
            indicator.className = `status-indicator status-${type}`;
            statusElement.querySelector('span').textContent = message;
        }

        // Tab management
        function showTab(tabName) {
            // Clear bulk selections when switching tabs
            bulkSelection.users.clear();
            bulkSelection.activities.clear();
            
            const usersCheckbox = document.getElementById('selectAllUsersCheckbox');
            if (usersCheckbox) usersCheckbox.checked = false;
            
            const activitiesCheckbox = document.getElementById('selectAllActivitiesCheckbox');
            if (activitiesCheckbox) activitiesCheckbox.checked = false;
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabName + 'Section').classList.remove('hidden');
            
            // Only activate tab button if it exists (manual doesn't have a tab button in nav)
            const tabButton = document.getElementById(tabName + 'Tab');
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Refresh content based on tab
            switch(tabName) {
                case 'dashboard':
                    refreshDashboard();
                    break;
                case 'users':
                    refreshUsersTable();
                    break;
                case 'activities':
                    refreshActivitiesTable();
                    break;
                case 'teams':
                    refreshTeamsTable();
                    updateTeamSortButtons();
                    break;
                case 'manual':
                    // Scroll to top when opening manual
                    window.scrollTo(0, 0);
                    break;
            }
        }

        // Dashboard functions
        function refreshDashboard() {
            const currentMonth = getCurrentMonth();
            
            // Update stats
            document.getElementById('totalUsers').textContent = formatNumber(appData.users.size);
            document.getElementById('completedActivities').textContent = formatNumber(appData.activities.length);
            document.getElementById('inProgressActivities').textContent = formatNumber(appData.inProgressActivities.length);
            document.getElementById('totalTeams').textContent = formatNumber(appData.teams.size);
            
            const totalPoints = Array.from(appData.users.values()).reduce((sum, user) => sum + user.totalPoints, 0);
            document.getElementById('totalPointsAwarded').textContent = formatNumber(totalPoints);
            
            const currentMonthActivities = appData.activities.filter(a => a.monthYear === currentMonth).length;
            document.getElementById('currentMonthActivities').textContent = formatNumber(currentMonthActivities);
            
            // Update leaderboards
            updateLeaderboard();
            updateTeamLeaderboard();
            
            // Update recent activities
            updateRecentActivities();
            
            // Update activity charts
            updateActivityCharts();
        }

        function updateLeaderboard() {
            const currentMonth = getCurrentMonth();
            const leaderboard = Array.from(appData.users.values())
                .filter(user => user.currentMonthPoints > 0)
                .sort((a, b) => b.currentMonthPoints - a.currentMonthPoints)
                .slice(0, 10);

            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = leaderboard.map((user, index) => `
                <tr class="${index < 3 ? 'bg-gradient-to-r from-yellow-50 to-orange-50' : 'hover:bg-gray-50'}">
                    <td class="px-4 py-3">
                        <span class="font-bold ${index === 0 ? 'text-yellow-600' : index === 1 ? 'text-gray-600' : index === 2 ? 'text-orange-600' : 'text-gray-800'}">
                            ${index + 1}${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : ''}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${user.name}</div>
                        <div class="text-sm text-gray-500">${user.email}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-bold text-purple-600">${formatNumber(user.currentMonthPoints)}</span>
                    </td>
                </tr>
            `).join('');
        }

        function updateTeamLeaderboard() {
            // Update all team points first
            updateAllTeamPoints();
            
            const teams = Array.from(appData.teams.values())
                .filter(team => team.currentMonthPoints > 0)
                .sort((a, b) => b.currentMonthPoints - a.currentMonthPoints)
                .slice(0, 5); // Show top 5 teams
            
            const tbody = document.getElementById('teamLeaderboardBody');
            
            if (teams.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-3 text-center text-gray-500 text-sm">
                            No team activity this month
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = teams.map((team, index) => {
                const colorClass = {
                    blue: 'bg-blue-100 text-blue-800',
                    green: 'bg-green-100 text-green-800',
                    purple: 'bg-purple-100 text-purple-800',
                    orange: 'bg-orange-100 text-orange-800',
                    pink: 'bg-pink-100 text-pink-800',
                    teal: 'bg-teal-100 text-teal-800',
                    indigo: 'bg-indigo-100 text-indigo-800',
                    red: 'bg-red-100 text-red-800'
                }[team.color] || 'bg-gray-100 text-gray-800';
                
                return `
                    <tr class="${index < 3 ? 'bg-gradient-to-r from-teal-50 to-cyan-50' : 'hover:bg-gray-50'}">
                        <td class="px-4 py-3">
                            <span class="font-bold ${index === 0 ? 'text-yellow-600' : index === 1 ? 'text-gray-600' : index === 2 ? 'text-orange-600' : 'text-gray-800'}">
                                ${index + 1}${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : ''}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="px-2 py-1 text-xs rounded-full ${colorClass} mr-2">
                                    ${team.name.substring(0, 2).toUpperCase()}
                                </span>
                                <div class="font-medium text-gray-900">${team.name}</div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-gray-600">${team.members.length}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-bold text-teal-600">${formatNumber(team.currentMonthPoints)}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateRecentActivities() {
            const recentActivities = appData.activities
                .sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate))
                .slice(0, 10);

            const container = document.getElementById('recentActivities');
            container.innerHTML = recentActivities.map(activity => {
                const user = appData.users.get(activity.userEmail);
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${user?.name || activity.userEmail}</div>
                            <div class="text-sm text-gray-600">${activity.title}</div>
                            <div class="text-xs text-gray-500">${formatDate(activity.completedDate)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-purple-600">+${activity.pointsEarned}</div>
                            <div class="text-xs text-gray-500">${activity.courseType}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateActivityCharts() {
            const chartContainer = document.getElementById('activityCharts');
            
            // Course type distribution
            const courseTypes = {};
            appData.activities.forEach(activity => {
                const type = activity.courseType || 'Unknown';
                courseTypes[type] = (courseTypes[type] || 0) + 1;
            });

            const topCourseTypes = Object.entries(courseTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            chartContainer.innerHTML = `
                <div class="text-center">
                    <h4 class="font-medium text-gray-900 mb-3">Top Course Types</h4>
                    <div class="space-y-2">
                        ${topCourseTypes.map(([type, count]) => `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600 truncate">${type}</span>
                                <span class="font-medium text-blue-600">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="text-center">
                    <h4 class="font-medium text-gray-900 mb-3">Monthly Activity</h4>
                    <div class="text-3xl font-bold text-green-600">${appData.activities.filter(a => a.monthYear === getCurrentMonth()).length}</div>
                    <div class="text-sm text-gray-500">This Month</div>
                </div>
                <div class="text-center">
                    <h4 class="font-medium text-gray-900 mb-3">Completion Rate</h4>
                    <div class="text-3xl font-bold text-purple-600">
                        ${appData.activities.length + appData.inProgressActivities.length > 0 ? 
                            Math.round((appData.activities.length / (appData.activities.length + appData.inProgressActivities.length)) * 100) : 0}%
                    </div>
                    <div class="text-sm text-gray-500">Activities Completed</div>
                </div>
            `;
        }

        // Team Management Functions
        function createTeam() {
            const name = document.getElementById('teamName').value.trim();
            const description = document.getElementById('teamDescription').value.trim();
            const color = document.getElementById('teamColor').value;
            
            if (!name) {
                alert('Please enter a team name');
                return;
            }
            
            // Check for duplicate team names
            const existingTeam = Array.from(appData.teams.values()).find(t => t.name.toLowerCase() === name.toLowerCase());
            if (existingTeam) {
                alert('A team with this name already exists');
                return;
            }
            
            const teamId = `team_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const team = {
                id: teamId,
                name: name,
                description: description,
                color: color,
                members: [], // Array of user emails
                createdDate: new Date().toISOString(),
                currentMonthPoints: 0,
                totalPoints: 0
            };
            
            appData.teams.set(teamId, team);
            
            closeCreateTeamModal();
            refreshTeamsTable(); // This will now apply current sorting
            refreshDashboard();
            autoSave();
            
            log(`✅ Team created: ${name}`);
        }

        function openCreateTeamModal() {
            document.getElementById('createTeamModal').classList.remove('hidden');
        }

        function closeCreateTeamModal() {
            document.getElementById('createTeamModal').classList.add('hidden');
            // Clear form
            document.getElementById('teamName').value = '';
            document.getElementById('teamDescription').value = '';
            document.getElementById('teamColor').value = 'blue';
        }

        function openManageTeamMembers(teamId) {
            const team = appData.teams.get(teamId);
            if (!team) return;
            
            // Set team info
            document.getElementById('managingTeamName').textContent = team.name;
            document.getElementById('managingTeamDescription').textContent = team.description || 'No description';
            document.getElementById('manageTeamMembersModal').dataset.teamId = teamId;
            
            // Populate available users (exclude those already in this team)
            const availableSelect = document.getElementById('availableUsers');
            availableSelect.innerHTML = '';
            
            Array.from(appData.users.values())
                .filter(user => !team.members.includes(user.email))
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = `${user.name} (${user.email})`;
                    availableSelect.appendChild(option);
                });
            
            // Show current members
            updateTeamMembersList(teamId);
            
            document.getElementById('manageTeamMembersModal').classList.remove('hidden');
        }

        function closeManageTeamMembersModal() {
            document.getElementById('manageTeamMembersModal').classList.add('hidden');
        }

        function addUsersToTeam() {
            const teamId = document.getElementById('manageTeamMembersModal').dataset.teamId;
            const team = appData.teams.get(teamId);
            if (!team) return;
            
            const selectedOptions = Array.from(document.getElementById('availableUsers').selectedOptions);
            
            selectedOptions.forEach(option => {
                const email = option.value;
                if (!team.members.includes(email)) {
                    team.members.push(email);
                    
                    // Update user's team assignment
                    const user = appData.users.get(email);
                    if (user) {
                        user.teamId = teamId;
                    }
                }
            });
            
            // Recalculate team points
            updateTeamPoints(teamId);
            
            // Refresh the modal and tables
            openManageTeamMembers(teamId);
            refreshTeamsTable(); // This will now apply current sorting
            refreshDashboard();
            autoSave();
            
            log(`✅ Added ${selectedOptions.length} users to team ${team.name}`);
        }

        function removeUserFromTeam(teamId, userEmail) {
            const team = appData.teams.get(teamId);
            if (!team) return;
            
            team.members = team.members.filter(email => email !== userEmail);
            
            // Remove team assignment from user
            const user = appData.users.get(userEmail);
            if (user && user.teamId === teamId) {
                delete user.teamId;
            }
            
            // Recalculate team points
            updateTeamPoints(teamId);
            
            updateTeamMembersList(teamId);
            refreshTeamsTable(); // This will now apply current sorting
            refreshDashboard();
            autoSave();
            
            log(`✅ Removed user from team ${team.name}`);
        }

        function updateTeamMembersList(teamId) {
            const team = appData.teams.get(teamId);
            if (!team) return;
            
            const container = document.getElementById('teamMembersList');
            
            if (team.members.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No members yet</p>';
                return;
            }
            
            container.innerHTML = team.members.map(email => {
                const user = appData.users.get(email);
                return `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <div>
                            <div class="font-medium text-gray-900">${user?.name || email}</div>
                            <div class="text-sm text-gray-500">${email}</div>
                            <div class="text-xs text-gray-600">Points this month: ${user?.currentMonthPoints || 0}</div>
                        </div>
                        <button onclick="removeUserFromTeam('${teamId}', '${email}')" 
                                class="text-red-600 hover:text-red-800 text-sm">
                            Remove
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateTeamPoints(teamId) {
            const team = appData.teams.get(teamId);
            if (!team) return;
            
            // Calculate team points from member points
            team.currentMonthPoints = team.members.reduce((sum, email) => {
                const user = appData.users.get(email);
                return sum + (user?.currentMonthPoints || 0);
            }, 0);
            
            team.totalPoints = team.members.reduce((sum, email) => {
                const user = appData.users.get(email);
                return sum + (user?.totalPoints || 0);
            }, 0);
        }

        function updateAllTeamPoints() {
            appData.teams.forEach((team, teamId) => {
                updateTeamPoints(teamId);
            });
        }

        function deleteTeam(teamId) {
            const team = appData.teams.get(teamId);
            if (!team) return;
            
            if (!confirm(`Are you sure you want to delete the team "${team.name}"? This cannot be undone.`)) {
                return;
            }
            
            // Remove team assignment from all members
            team.members.forEach(email => {
                const user = appData.users.get(email);
                if (user && user.teamId === teamId) {
                    delete user.teamId;
                }
            });
            
            appData.teams.delete(teamId);
            
            refreshTeamsTable(); // This will now apply current sorting
            refreshDashboard();
            autoSave();
            
            log(`🗑️ Team deleted: ${team.name}`);
        }

        function refreshTeamsTable() {
            const tbody = document.getElementById('teamsTableBody');
            
            // Update all team points first
            updateAllTeamPoints();
            
            let teams = Array.from(appData.teams.values());
            
            // Apply sorting
            teams.sort((a, b) => {
                let aValue, bValue;
                
                if (sortState.teams.field === 'members') {
                    aValue = a.members.length;
                    bValue = b.members.length;
                } else {
                    aValue = a[sortState.teams.field];
                    bValue = b[sortState.teams.field];
                }
                
                // Handle different data types
                if (typeof aValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }
                
                if (sortState.teams.ascending) {
                    return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                } else {
                    return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                }
            });
            
            if (teams.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            No teams created yet. Click "Create Team" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = teams.map(team => {
                const colorClass = {
                    blue: 'bg-blue-100 text-blue-800',
                    green: 'bg-green-100 text-green-800',
                    purple: 'bg-purple-100 text-purple-800',
                    orange: 'bg-orange-100 text-orange-800',
                    pink: 'bg-pink-100 text-pink-800',
                    teal: 'bg-teal-100 text-teal-800',
                    indigo: 'bg-indigo-100 text-indigo-800',
                    red: 'bg-red-100 text-red-800'
                }[team.color] || 'bg-gray-100 text-gray-800';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="px-2 py-1 text-xs rounded-full ${colorClass} mr-2">
                                    ${team.name.substring(0, 2).toUpperCase()}
                                </span>
                                <div>
                                    <div class="font-medium text-gray-900">${team.name}</div>
                                    <div class="text-sm text-gray-500">${team.description || 'No description'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-gray-600">${team.members.length}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-bold text-teal-600">${formatNumber(team.currentMonthPoints)}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-medium text-gray-900">${formatNumber(team.totalPoints)}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-sm text-gray-500">${formatDate(team.createdDate)}</span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2">
                                <button onclick="openManageTeamMembers('${team.id}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm">
                                    Manage
                                </button>
                                <button onclick="deleteTeam('${team.id}')" 
                                        class="text-red-600 hover:text-red-800 text-sm">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateTeamSortButtons();
        }

        // Sort toggle functions for Teams
        function toggleTeamSort(field) {
            if (sortState.teams.field === field) {
                // Same field, toggle order
                sortState.teams.ascending = !sortState.teams.ascending;
            } else {
                // Different field, set new field and default to descending (most first)
                sortState.teams.field = field;
                sortState.teams.ascending = false;
            }
            refreshTeamsTable();
        }

        function toggleTeamSortOrder() {
            sortState.teams.ascending = !sortState.teams.ascending;
            refreshTeamsTable();
        }

        function updateTeamSortButtons() {
            // Reset all buttons
            ['sortMembers', 'sortTeamCurrentMonth', 'sortTeamTotal'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.className = 'px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors';
                }
            });
            
            // Highlight active field
            let activeField;
            if (sortState.teams.field === 'members') {
                activeField = 'sortMembers';
            } else if (sortState.teams.field === 'currentMonthPoints') {
                activeField = 'sortTeamCurrentMonth';
            } else {
                activeField = 'sortTeamTotal';
            }
            
            const activeBtn = document.getElementById(activeField);
            if (activeBtn) {
                activeBtn.className = 'px-3 py-1 text-xs rounded-lg bg-blue-100 text-blue-800 border border-blue-300';
            }
            
            // Update sort order button
            const orderBtn = document.getElementById('sortOrderTeam');
            if (orderBtn) {
                if (sortState.teams.field === 'members') {
                    orderBtn.textContent = sortState.teams.ascending ? 'Least First ⬆️' : 'Most First ⬇️';
                } else {
                    orderBtn.textContent = sortState.teams.ascending ? 'Least First ⬆️' : 'Most First ⬇️';
                }
            }
        }

        function filterTeams() {
            const searchTerm = document.getElementById('teamSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#teamsTableBody tr');
            
            // Don't filter if there's an empty state message
            if (rows.length === 1 && rows[0].querySelector('td[colspan]')) {
                return;
            }
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Configuration functions (same as POC but integrated)
        function updatePointConfig() {
            // AWS Course Types
            appData.config.pointConfig.awsCourseTypes['AWS Builder Lab'] = parseInt(document.getElementById('awsBuilderLab').value);
            appData.config.pointConfig.awsCourseTypes['AWS Cloud Quest'] = parseInt(document.getElementById('awsCloudQuest').value);
            appData.config.pointConfig.awsCourseTypes['AWS Jam Journey'] = parseInt(document.getElementById('awsJamJourney').value);
            appData.config.pointConfig.awsCourseTypes['AWS Simulearn'] = parseInt(document.getElementById('awsSimulearn').value);
            appData.config.pointConfig.awsCourseTypes['Certification Exam Preparation'] = parseInt(document.getElementById('certExamPrep').value);
            appData.config.pointConfig.awsCourseTypes['Digital Course With Lab'] = parseInt(document.getElementById('digitalCourseWithLab').value);
            
            // General Course Categories
            appData.config.pointConfig.generalCourses['Classroom Training'] = parseInt(document.getElementById('classroomTraining').value);
            appData.config.pointConfig.generalCourses['Digital Courses - Foundational'] = parseInt(document.getElementById('digitalFoundational').value);
            appData.config.pointConfig.generalCourses['Digital Courses - Associate'] = parseInt(document.getElementById('digitalAssociate').value);
            appData.config.pointConfig.generalCourses['Digital Courses - Professional'] = parseInt(document.getElementById('digitalProfessional').value);
            appData.config.pointConfig.generalCourses['Digital Courses - Specialty'] = parseInt(document.getElementById('digitalSpecialty').value);
            
            // Events
            appData.config.pointConfig.events['Live Events'] = parseInt(document.getElementById('liveEvents').value);
            
            // Hackathons
            appData.config.pointConfig.hackathons['Hackathons - Participation'] = parseInt(document.getElementById('hackathonParticipation').value);
            appData.config.pointConfig.hackathons['Hackathons - 3rd Place'] = parseInt(document.getElementById('hackathon3rd').value);
            appData.config.pointConfig.hackathons['Hackathons - 2nd Place'] = parseInt(document.getElementById('hackathon2nd').value);
            appData.config.pointConfig.hackathons['Hackathons - 1st Place'] = parseInt(document.getElementById('hackathon1st').value);
            
            // Quizzes
            appData.config.pointConfig.quizzes['Quiz Completion'] = parseInt(document.getElementById('quizCompletion').value);
            appData.config.pointConfig.quizzes['Quiz 80%+ Score'] = parseInt(document.getElementById('quiz80Plus').value);
            appData.config.pointConfig.quizzes['Quiz Perfect Score'] = parseInt(document.getElementById('quizPerfect').value);
            
            log('🔧 Point configuration updated');
        }

        function loadConfiguration() {
            const config = appData.config.pointConfig;
            
            // AWS Course Types
            document.getElementById('awsBuilderLab').value = config.awsCourseTypes['AWS Builder Lab'];
            document.getElementById('awsCloudQuest').value = config.awsCourseTypes['AWS Cloud Quest'];
            document.getElementById('awsJamJourney').value = config.awsCourseTypes['AWS Jam Journey'];
            document.getElementById('awsSimulearn').value = config.awsCourseTypes['AWS Simulearn'];
            document.getElementById('certExamPrep').value = config.awsCourseTypes['Certification Exam Preparation'];
            document.getElementById('digitalCourseWithLab').value = config.awsCourseTypes['Digital Course With Lab'];
            
            // General Course Categories
            document.getElementById('classroomTraining').value = config.generalCourses['Classroom Training'];
            document.getElementById('digitalFoundational').value = config.generalCourses['Digital Courses - Foundational'];
            document.getElementById('digitalAssociate').value = config.generalCourses['Digital Courses - Associate'];
            document.getElementById('digitalProfessional').value = config.generalCourses['Digital Courses - Professional'];
            document.getElementById('digitalSpecialty').value = config.generalCourses['Digital Courses - Specialty'];
            
            // Events
            document.getElementById('liveEvents').value = config.events['Live Events'];
            
            // Hackathons
            document.getElementById('hackathonParticipation').value = config.hackathons['Hackathons - Participation'];
            document.getElementById('hackathon3rd').value = config.hackathons['Hackathons - 3rd Place'];
            document.getElementById('hackathon2nd').value = config.hackathons['Hackathons - 2nd Place'];
            document.getElementById('hackathon1st').value = config.hackathons['Hackathons - 1st Place'];
            
            // Quizzes
            document.getElementById('quizCompletion').value = config.quizzes['Quiz Completion'];
            document.getElementById('quiz80Plus').value = config.quizzes['Quiz 80%+ Score'];
            document.getElementById('quizPerfect').value = config.quizzes['Quiz Perfect Score'];
        }

        function resetToDefaults() {
            // AWS Course Types
            document.getElementById('awsBuilderLab').value = 100;
            document.getElementById('awsCloudQuest').value = 75;
            document.getElementById('awsJamJourney').value = 150;
            document.getElementById('awsSimulearn').value = 75;
            document.getElementById('certExamPrep').value = 100;
            document.getElementById('digitalCourseWithLab').value = 100;
            
            // General Course Categories
            document.getElementById('classroomTraining').value = 100;
            document.getElementById('digitalFoundational').value = 50;
            document.getElementById('digitalAssociate').value = 75;
            document.getElementById('digitalProfessional').value = 100;
            document.getElementById('digitalSpecialty').value = 100;
            
            // Events
            document.getElementById('liveEvents').value = 25;
            
            // Hackathons
            document.getElementById('hackathonParticipation').value = 150;
            document.getElementById('hackathon3rd').value = 250;
            document.getElementById('hackathon2nd').value = 350;
            document.getElementById('hackathon1st').value = 450;
            
            // Quizzes
            document.getElementById('quizCompletion').value = 20;
            document.getElementById('quiz80Plus').value = 50;
            document.getElementById('quizPerfect').value = 70;
            
            updatePointConfig();
            log('🔄 Configuration reset to defaults');
        }

        function saveConfiguration() {
            updatePointConfig();
            autoSave(); // Auto-save configuration changes
            const status = document.getElementById('configStatus');
            status.textContent = '✅ Configuration saved!';
            setTimeout(() => {
                status.textContent = '';
            }, 3000);
        }

        function exportConfig() {
            downloadJSON(appData.config, 'cloud_comp_config.json');
        }

        // Point calculation (same logic as POC)
        function calculatePoints(courseLevel, courseType, activityType = 'course', score = null, placement = null) {
            const config = appData.config.pointConfig;
            
            if (activityType === 'live_event') {
                return config.events['Live Events'];
            }
            
            if (activityType === 'hackathon') {
                if (placement === 1) return config.hackathons['Hackathons - 1st Place'];
                if (placement === 2) return config.hackathons['Hackathons - 2nd Place'];
                if (placement === 3) return config.hackathons['Hackathons - 3rd Place'];
                return config.hackathons['Hackathons - Participation'];
            }
            
            if (activityType === 'quiz') {
                if (score === 100) return config.quizzes['Quiz Perfect Score'];
                if (score >= 80) return config.quizzes['Quiz 80%+ Score'];
                return config.quizzes['Quiz Completion'];
            }

            // Handle specific AWS course types
            if (courseType && config.awsCourseTypes[courseType]) {
                return config.awsCourseTypes[courseType];
            }
            
            // Handle course types with keywords
            if (courseType) {
                if (courseType.includes('Builder Lab')) return config.awsCourseTypes['AWS Builder Lab'];
                if (courseType.includes('Cloud Quest')) return config.awsCourseTypes['AWS Cloud Quest'];
                if (courseType.includes('Jam Journey')) return config.awsCourseTypes['AWS Jam Journey'];
                if (courseType.includes('Simulearn')) return config.awsCourseTypes['AWS Simulearn'];
                if (courseType.includes('Certification Exam Preparation')) return config.awsCourseTypes['Certification Exam Preparation'];
                if (courseType.includes('With Lab')) return config.awsCourseTypes['Digital Course With Lab'];
                if (courseType.includes('Classroom')) return config.generalCourses['Classroom Training'];
            }

            // Handle by level
            if (courseLevel) {
                const level = courseLevel.toLowerCase();
                if (level === 'fundamental') return config.generalCourses['Digital Courses - Foundational'];
                if (level === 'intermediate') return config.generalCourses['Digital Courses - Associate'];
                if (level === 'advanced') return config.generalCourses['Digital Courses - Professional'];
                if (level === 'specialty') return config.generalCourses['Digital Courses - Specialty'];
            }
            
            // Default fallback
            return config.generalCourses['Digital Courses - Foundational'];
        }

        // File handling
        function updateFileList(type, files) {
            const listElement = document.getElementById(type + 'FileList');
            if (files.length === 0) {
                listElement.innerHTML = '';
                return;
            }
            
            if (files.length === 1) {
                listElement.innerHTML = `<div class="text-xs"><strong>1 file selected:</strong><br>${files[0].name}</div>`;
            } else {
                const fileList = Array.from(files).map((f, index) => `${index + 1}. ${f.name}`).join('<br>');
                listElement.innerHTML = `<div class="text-xs"><strong>${files.length} files selected:</strong><br>${fileList}</div>`;
            }
            
            const hasFiles = selectedFiles.course.length > 0 || selectedFiles.teams.length > 0;
            document.getElementById('processBtn').disabled = !hasFiles;
        }

        // Import processing
        async function processAllFiles() {
            if (!selectedFiles.course.length && !selectedFiles.teams.length) {
                alert('Please select files to process');
                return;
            }

            log('🚀 Starting multi-file processing...');
            log(`📁 Course files: ${selectedFiles.course.length}`);
            log(`👥 Teams files: ${selectedFiles.teams.length}`);
            document.getElementById('importResults').classList.remove('hidden');
            
            let totalProcessed = 0;
            let totalActivities = 0;
            let totalInProgress = 0;
            
            // Process course files
            for (let file of selectedFiles.course) {
                const result = await processCourseFile(file);
                totalProcessed += result.processed;
                totalActivities += result.activities;
                totalInProgress += result.inProgressCount || 0;
            }
            
            // Process Teams files
            for (let file of selectedFiles.teams) {
                const result = await processTeamsFile(file);
                totalProcessed += result.processed;
                totalActivities += result.activities;
            }
            
            // Update metadata
            appData.metadata.lastImport = new Date().toISOString();
            appData.metadata.totalRecordsProcessed += totalProcessed;
            appData.metadata.sources = [...new Set([...appData.metadata.sources, ...selectedFiles.course.map(f => f.name), ...selectedFiles.teams.map(f => f.name)])];
            
            log(`✅ Multi-file processing complete!`);
            log(`📊 Total: ${totalActivities} completed activities, ${totalInProgress} in-progress activities from ${totalProcessed} records`);
            log(`👥 Processed ${selectedFiles.course.length} course files and ${selectedFiles.teams.length} Teams files`);
            
            // Update UI
            updateImportStats(totalProcessed, totalActivities, totalInProgress);
            refreshDashboard();
            
            // Auto-save after import
            await autoSave();
            
            // Clear file selections
            selectedFiles.course = [];
            selectedFiles.teams = [];
            updateFileList('course', []);
            updateFileList('teams', []);
            document.getElementById('processBtn').disabled = true;
        }

        async function processCourseFile(file) {
            return new Promise((resolve) => {
                log(`📚 Processing course file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                        // Find header row
                        let headerRow = -1;
                        for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                            if (jsonData[i] && jsonData[i].includes('Email')) {
                                headerRow = i;
                                break;
                            }
                        }
                        
                        if (headerRow === -1) {
                            log(`❌ Could not find header row in ${file.name}`);
                            resolve({ processed: 0, activities: 0 });
                            return;
                        }
                        
                        const headers = jsonData[headerRow];
                        const dataRows = jsonData.slice(headerRow + 1);

                        const records = dataRows.map(row => {
                            const record = {};
                            headers.forEach((header, index) => {
                                record[header] = row[index];
                            });
                            return record;
                        });

                        let processed = 0, activities = 0, inProgressCount = 0;
                        records.forEach((record, index) => {
                            const result = processRecord(record, index, file.name);
                            processed++;
                            if (result.processed) {
                                if (result.type === 'completed') {
                                    activities++;
                                } else if (result.type === 'in-progress') {
                                    inProgressCount++;
                                }
                            }
                        });

                        log(`✅ ${file.name}: ${activities} completed, ${inProgressCount} in-progress from ${processed} records`);
                        resolve({ processed, activities, inProgressCount });

                    } catch (error) {
                        log(`❌ Error processing ${file.name}: ${error.message}`);
                        resolve({ processed: 0, activities: 0 });
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function processTeamsFile(file) {
            return new Promise((resolve) => {
                log(`👥 Processing Teams file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const meetingData = parseTeamsMeetingData(content, file.name);
                        const activities = processTeamsMeetingActivities(meetingData, file.name);
                        
                        // Add activities to appData
                        activities.forEach(activity => {
                            appData.activities.push(activity);
                            
                            // Update or create user
                            const email = activity.userEmail;
                            if (!appData.users.has(email)) {
                                appData.users.set(email, {
                                    email: email,
                                    name: `Meeting Attendee ${email.split('_')[1] || Math.random().toString(36).substr(2, 4)}`,
                                    firstName: 'Meeting',
                                    lastName: 'Attendee',
                                    currentMonthPoints: 0,
                                    totalPoints: 0,
                                    activities: [],
                                    inProgressActivities: [],
                                    joinDate: new Date().toISOString(),
                                    lastActivity: activity.completedDate
                                });
                            }

                            const user = appData.users.get(email);
                            user.activities = user.activities || [];
                            user.activities.push(activity.id);
                            user.totalPoints += activity.pointsEarned;
                            user.lastActivity = activity.completedDate;
                            
                            if (activity.monthYear === getCurrentMonth()) {
                                user.currentMonthPoints += activity.pointsEarned;
                            }
                        });

                        log(`✅ ${file.name}: ${activities.length} meeting attendance activities created`);
                        resolve({ processed: meetingData.length, activities: activities.length });

                    } catch (error) {
                        log(`❌ Error processing Teams file ${file.name}: ${error.message}`);
                        resolve({ processed: 0, activities: 0 });
                    }
                };
                reader.readAsText(file);
            });
        }

        // Parse Teams meeting data from CSV content
        function parseTeamsMeetingData(content, filename) {
            log(`👥 Parsing Teams meeting data from: ${filename}`);
            
            try {
                const lines = content.split('\n').filter(line => line.trim());
                const meetingData = [];
                
                let currentMeeting = null;
                let attendeeEmails = [];
                
                for (let line of lines) {
                    // Clean up the line - remove null bytes and extra whitespace
                    const cleanLine = line.replace(/\0/g, '').trim();
                    
                    // Skip empty lines
                    if (!cleanLine) continue;
                    
                    // Look for meeting title
                    if (cleanLine.includes('Meeting title') || cleanLine.includes('Meeting Title')) {
                        const titleMatch = cleanLine.match(/Meeting\s+title[:\t]\s*(.+?)(?:\s*\(|$)/i);
                        if (titleMatch) {
                            // Save previous meeting if exists
                            if (currentMeeting && attendeeEmails.length > 0) {
                                currentMeeting.attendeeEmails = [...attendeeEmails];
                                meetingData.push(currentMeeting);
                            }
                            
                            currentMeeting = {
                                title: titleMatch[1].trim(),
                                attendees: 0,
                                attendeeEmails: [],
                                date: new Date().toISOString(), // Default to today, could be parsed from filename
                                meetingId: `meeting_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            };
                            attendeeEmails = [];
                        }
                    }
                    
                    // Look for attended participants count
                    if (cleanLine.includes('Attended participants') || cleanLine.includes('Attended Participants')) {
                        const countMatch = cleanLine.match(/Attended\s+participants[:\t]\s*(\d+)/i);
                        if (countMatch && currentMeeting) {
                            currentMeeting.attendees = parseInt(countMatch[1]);
                        }
                    }
                    
                    // Look for individual attendee emails (common Teams export format)
                    const emailMatch = cleanLine.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                    if (emailMatch && currentMeeting) {
                        const email = emailMatch[1].toLowerCase().trim();
                        if (!attendeeEmails.includes(email)) {
                            attendeeEmails.push(email);
                        }
                    }
                    
                    // Alternative: look for participant names (if emails not available)
                    if (!emailMatch && currentMeeting && cleanLine.length > 3 && 
                        !cleanLine.includes('Meeting') && !cleanLine.includes('Attended') && 
                        !cleanLine.includes('Summary') && !cleanLine.includes('participants')) {
                        // Generate pseudo-email for participant name
                        const pseudoEmail = `${cleanLine.replace(/\s+/g, '.').toLowerCase()}@meeting.placeholder`;
                        if (!attendeeEmails.includes(pseudoEmail)) {
                            attendeeEmails.push(pseudoEmail);
                        }
                    }
                }
                
                // Save the last meeting
                if (currentMeeting && attendeeEmails.length > 0) {
                    currentMeeting.attendeeEmails = [...attendeeEmails];
                    meetingData.push(currentMeeting);
                }
                
                // If we found meetings but no individual emails, create placeholders based on count
                meetingData.forEach(meeting => {
                    if (meeting.attendeeEmails.length === 0 && meeting.attendees > 0) {
                        for (let i = 0; i < meeting.attendees; i++) {
                            meeting.attendeeEmails.push(`attendee_${i}@${meeting.meetingId}.placeholder`);
                        }
                    }
                });
                
                log(`📊 Found ${meetingData.length} meetings with attendee data`);
                return meetingData;
                
            } catch (error) {
                log(`❌ Error parsing Teams data: ${error.message}`);
                return [];
            }
        }

        // Process Teams meeting data into activities
        function processTeamsMeetingActivities(meetingData, filename) {
            const activities = [];
            
            meetingData.forEach((meeting, meetingIndex) => {
                meeting.attendeeEmails.forEach((email, attendeeIndex) => {
                    // Check for duplicates (same email + meeting)
                    const duplicateKey = `${email}|${meeting.meetingId}`;
                    const existingActivity = appData.activities.find(a => 
                        a.userEmail === email && a.courseId === meeting.meetingId);
                    
                    if (existingActivity) {
                        // Skip duplicate
                        return;
                    }
                    
                    const activity = {
                        id: `teams_${Date.now()}_${meetingIndex}_${attendeeIndex}`,
                        userEmail: email,
                        courseId: meeting.meetingId,
                        title: meeting.title,
                        level: 'live_event',
                        courseType: 'Teams Meeting',
                        pointsEarned: calculatePoints(null, null, 'live_event'),
                        completedDate: meeting.date,
                        source: filename,
                        importDate: new Date().toISOString(),
                        monthYear: getMonthFromDate(meeting.date)
                    };
                    
                    activities.push(activity);
                });
            });
            
            log(`✅ Created ${activities.length} Teams meeting attendance activities`);
            return activities;
        }

        function processRecord(record, index, filename) {
            const email = record['Email']?.toString()?.toLowerCase()?.trim();
            const courseId = record['Course ID']?.toString()?.trim();
            const courseTitle = record['Course Title']?.toString()?.trim();
            const courseLevel = record['Level']?.toString()?.trim();
            const courseType = record['CourseType']?.toString()?.trim();
            const status = record['Status']?.toString()?.trim()?.toUpperCase();
            const completedDate = record['Completed on'];
            const startedDate = record['Started on'] || record['Enrolled on'];
            const progress = record['Progress %'] || 0;
            const score = record['Score'];

            // Skip if missing essential data
            if (!email || !courseId || !courseTitle) {
                return { skipped: true, reason: 'Missing data' };
            }

            // Handle IN PROGRESS activities
            if (status === 'IN PROGRESS') {
                const startedISO = parseDate(startedDate);
                if (!startedISO) {
                    return { skipped: true, reason: 'Invalid start date' };
                }

                // Check for duplicates in in-progress activities
                const existingInProgress = appData.inProgressActivities.find(a => a.userEmail === email && a.courseId === courseId);
                if (existingInProgress) {
                    // Update existing in-progress activity
                    existingInProgress.progress = parseFloat(progress) || 0;
                    existingInProgress.lastAccessed = record['LastAccessed on'] ? parseDate(record['LastAccessed on']) : startedISO;
                    return { skipped: true, reason: 'In-progress updated' };
                }

                // Create in-progress activity
                const inProgressActivity = {
                    id: `inprogress_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    userEmail: email,
                    courseId: courseId,
                    title: courseTitle,
                    level: courseLevel?.toLowerCase() || 'unknown',
                    courseType: courseType || 'unknown',
                    progress: parseFloat(progress) || 0,
                    startedDate: startedISO,
                    lastAccessed: record['LastAccessed on'] ? parseDate(record['LastAccessed on']) : startedISO,
                    estimatedHours: parseFloat(record['Estimated Time to Complete (in hours)']) || 0,
                    timeSpent: parseFloat(record['Estimated Time Spent (in hours)']) || 0,
                    source: filename,
                    importDate: new Date().toISOString(),
                    status: 'IN PROGRESS'
                };

                appData.inProgressActivities.push(inProgressActivity);
                
                // Update user data (but don't award points for in-progress)
                if (!appData.users.has(email)) {
                    appData.users.set(email, {
                        email: email,
                        name: `${record['First Name'] || ''} ${record['Last Name'] || ''}`.trim(),
                        firstName: record['First Name'] || '',
                        lastName: record['Last Name'] || '',
                        currentMonthPoints: 0,
                        totalPoints: 0,
                        activities: [],
                        inProgressActivities: [],
                        joinDate: new Date().toISOString(),
                        lastActivity: startedISO
                    });
                }

                const user = appData.users.get(email);
                user.inProgressActivities = user.inProgressActivities || [];
                user.inProgressActivities.push(inProgressActivity.id);
                user.lastActivity = startedISO;

                return { processed: true, points: 0, type: 'in-progress' };
            }

            // Handle COMPLETED activities (existing logic)
            if (status !== 'COMPLETED') {
                return { skipped: true, reason: `Status: ${status}` };
            }

            const completedISO = parseDate(completedDate);
            if (!completedISO) {
                return { skipped: true, reason: 'Invalid date' };
            }

            // Check for duplicates in completed activities
            const existingActivity = appData.activities.find(a => a.userEmail === email && a.courseId === courseId);
            if (existingActivity) {
                return { skipped: true, reason: 'Duplicate' };
            }

            // Remove from in-progress if it exists (course was completed)
            const inProgressIndex = appData.inProgressActivities.findIndex(a => a.userEmail === email && a.courseId === courseId);
            if (inProgressIndex !== -1) {
                appData.inProgressActivities.splice(inProgressIndex, 1);
                
                // Also remove from user's in-progress list
                const user = appData.users.get(email);
                if (user && user.inProgressActivities) {
                    user.inProgressActivities = user.inProgressActivities.filter(id => !id.startsWith('inprogress_'));
                }
            }

            // Detect activity type and calculate points
            let activityType = 'course';
            let numericScore = null;
            
            if (courseType && (courseType.includes('Quiz') || courseType.includes('Card Clash'))) {
                activityType = 'quiz';
                if (score && !isNaN(parseFloat(score))) {
                    numericScore = parseFloat(score);
                }
            }
            
            const points = calculatePoints(courseLevel, courseType, activityType, numericScore);
            const monthYear = getMonthFromDate(completedISO);

            // Create completed activity
            const activity = {
                id: `activity_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                userEmail: email,
                courseId: courseId,
                title: courseTitle,
                level: courseLevel?.toLowerCase() || 'unknown',
                courseType: courseType || 'unknown',
                pointsEarned: points,
                completedDate: completedISO,
                score: numericScore,
                source: filename,
                importDate: new Date().toISOString(),
                monthYear: monthYear
            };

            appData.activities.push(activity);

            // Update or create user
            if (!appData.users.has(email)) {
                appData.users.set(email, {
                    email: email,
                    name: `${record['First Name'] || ''} ${record['Last Name'] || ''}`.trim(),
                    firstName: record['First Name'] || '',
                    lastName: record['Last Name'] || '',
                    currentMonthPoints: 0,
                    totalPoints: 0,
                    activities: [],
                    inProgressActivities: [],
                    joinDate: new Date().toISOString(),
                    lastActivity: completedISO
                });
            }

            const user = appData.users.get(email);
            user.activities = user.activities || [];
            user.activities.push(activity.id);
            user.totalPoints += points;
            user.lastActivity = completedISO;
            
            if (monthYear === getCurrentMonth()) {
                user.currentMonthPoints += points;
            }

            return { processed: true, points: points, type: 'completed' };
        }

        function parseDate(dateStr) {
            if (!dateStr || dateStr === 'null' || dateStr === '') return null;
            
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return null;
                return date.toISOString();
            } catch (e) {
                return null;
            }
        }

        function getMonthFromDate(isoDate) {
            if (!isoDate) return null;
            return isoDate.slice(0, 7);
        }

        function updateImportStats(totalProcessed, totalActivities, totalInProgress = 0) {
            const statsContainer = document.getElementById('importStats');
            statsContainer.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600">${formatNumber(totalProcessed)}</div>
                    <div class="text-sm text-blue-800">Records Processed</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600">${formatNumber(totalActivities)}</div>
                    <div class="text-sm text-green-800">Completed Activities</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600">${formatNumber(totalInProgress)}</div>
                    <div class="text-sm text-orange-800">In Progress</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600">${formatNumber(appData.users.size)}</div>
                    <div class="text-sm text-purple-800">Total Users</div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-indigo-600">${formatNumber(Array.from(appData.users.values()).reduce((sum, user) => sum + user.totalPoints, 0))}</div>
                    <div class="text-sm text-indigo-800">Points Awarded</div>
                </div>
            `;
        }

        // User management functions
        function refreshUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            let users = Array.from(appData.users.values());
            
            // Apply sorting
            users.sort((a, b) => {
                let aValue = a[sortState.users.field];
                let bValue = b[sortState.users.field];
                
                // Handle different data types
                if (typeof aValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }
                
                if (sortState.users.ascending) {
                    return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                } else {
                    return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                }
            });
            
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <input type="checkbox" 
                               class="user-checkbox rounded" 
                               value="${user.email}"
                               onchange="toggleUserSelection('${user.email}')"
                               ${bulkSelection.users.has(user.email) ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${user.name}</div>
                        <div class="text-sm text-gray-500">${user.email}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-bold text-purple-600">${formatNumber(user.currentMonthPoints)}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-medium text-gray-900">${formatNumber(user.totalPoints)}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-gray-600">${user.activities?.length || 0}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-sm text-gray-500">${formatDate(user.lastActivity)}</span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="viewUserDetails('${user.email}')" class="text-blue-600 hover:text-blue-800 text-sm">View</button>
                    </td>
                </tr>
            `).join('');
            
            updateUserSortButtons();
            updateBulkSelectionUI('users');
        }

        // Bulk selection functions for Users
        function toggleUserSelection(email) {
            if (bulkSelection.users.has(email)) {
                bulkSelection.users.delete(email);
            } else {
                bulkSelection.users.add(email);
            }
            updateBulkSelectionUI('users');
        }

        function toggleSelectAllUsers() {
            const checkbox = document.getElementById('selectAllUsersCheckbox');
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            
            if (checkbox.checked) {
                userCheckboxes.forEach(cb => {
                    cb.checked = true;
                    bulkSelection.users.add(cb.value);
                });
            } else {
                userCheckboxes.forEach(cb => {
                    cb.checked = false;
                });
                bulkSelection.users.clear();
            }
            updateBulkSelectionUI('users');
        }

        function selectAllUsers() {
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            userCheckboxes.forEach(cb => {
                cb.checked = true;
                bulkSelection.users.add(cb.value);
            });
            document.getElementById('selectAllUsersCheckbox').checked = true;
            updateBulkSelectionUI('users');
        }

        function deselectAllUsers() {
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            userCheckboxes.forEach(cb => {
                cb.checked = false;
            });
            bulkSelection.users.clear();
            document.getElementById('selectAllUsersCheckbox').checked = false;
            updateBulkSelectionUI('users');
        }

        function updateBulkSelectionUI(type) {
            if (type === 'users') {
                const count = bulkSelection.users.size;
                const bulkActionsBar = document.getElementById('userBulkActions');
                const countElement = document.getElementById('selectedUsersCount');
                
                if (count > 0) {
                    bulkActionsBar.classList.remove('hidden');
                    countElement.textContent = count;
                } else {
                    bulkActionsBar.classList.add('hidden');
                }
            } else if (type === 'activities') {
                const count = bulkSelection.activities.size;
                const bulkActionsBar = document.getElementById('activityBulkActions');
                const countElement = document.getElementById('selectedActivitiesCount');
                
                if (count > 0) {
                    bulkActionsBar.classList.remove('hidden');
                    countElement.textContent = count;
                } else {
                    bulkActionsBar.classList.add('hidden');
                }
            }
        }

        // Bulk operations for Users
        function bulkAwardPoints() {
            if (bulkSelection.users.size === 0) {
                alert('Please select users first');
                return;
            }
            
            document.getElementById('bulkAwardUserCount').textContent = bulkSelection.users.size;
            document.getElementById('bulkAwardPointsModal').classList.remove('hidden');
        }

        function closeBulkAwardPointsModal() {
            document.getElementById('bulkAwardPointsModal').classList.add('hidden');
            document.getElementById('bulkActivityTitle').value = '';
            document.getElementById('bulkPoints').value = '';
            document.getElementById('bulkDescription').value = '';
        }

        function submitBulkAwardPoints() {
            const title = document.getElementById('bulkActivityTitle').value.trim();
            const points = parseInt(document.getElementById('bulkPoints').value);
            const description = document.getElementById('bulkDescription').value.trim();

            if (!title || !points) {
                alert('Please fill in all required fields');
                return;
            }

            let successCount = 0;
            bulkSelection.users.forEach(email => {
                const activity = {
                    id: `bulk_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    userEmail: email,
                    courseId: `bulk_${Date.now()}`,
                    title: title,
                    level: 'manual',
                    courseType: 'Bulk Award',
                    pointsEarned: points,
                    completedDate: new Date().toISOString(),
                    score: null,
                    source: 'bulk_award',
                    importDate: new Date().toISOString(),
                    monthYear: getCurrentMonth(),
                    description: description
                };

                appData.activities.push(activity);

                const user = appData.users.get(email);
                if (user) {
                    user.activities = user.activities || [];
                    user.activities.push(activity.id);
                    user.totalPoints += points;
                    user.currentMonthPoints += points;
                    user.lastActivity = new Date().toISOString();
                    successCount++;
                }
            });

            closeBulkAwardPointsModal();
            deselectAllUsers();
            refreshDashboard();
            refreshUsersTable();
            refreshActivitiesTable();
            autoSave();

            log(`✅ Bulk awarded ${points} points to ${successCount} users for "${title}"`);
            alert(`Successfully awarded ${points} points to ${successCount} users!`);
        }

        function bulkAssignTeam() {
            if (bulkSelection.users.size === 0) {
                alert('Please select users first');
                return;
            }
            
            // Populate team dropdown
            const select = document.getElementById('bulkTeamSelect');
            select.innerHTML = '<option value="">Choose a team...</option>';
            appData.teams.forEach(team => {
                select.innerHTML += `<option value="${team.id}">${team.name}</option>`;
            });
            
            document.getElementById('bulkAssignUserCount').textContent = bulkSelection.users.size;
            document.getElementById('bulkAssignTeamModal').classList.remove('hidden');
        }

        function closeBulkAssignTeamModal() {
            document.getElementById('bulkAssignTeamModal').classList.add('hidden');
            document.getElementById('bulkTeamSelect').value = '';
        }

        function submitBulkAssignTeam() {
            const teamId = document.getElementById('bulkTeamSelect').value;
            
            if (!teamId) {
                alert('Please select a team');
                return;
            }
            
            const team = appData.teams.get(teamId);
            if (!team) return;
            
            let successCount = 0;
            bulkSelection.users.forEach(email => {
                if (!team.members.includes(email)) {
                    team.members.push(email);
                    
                    const user = appData.users.get(email);
                    if (user) {
                        // Remove from previous team if exists
                        if (user.teamId) {
                            const oldTeam = appData.teams.get(user.teamId);
                            if (oldTeam) {
                                oldTeam.members = oldTeam.members.filter(e => e !== email);
                            }
                        }
                        user.teamId = teamId;
                        successCount++;
                    }
                }
            });
            
            updateTeamPoints(teamId);
            closeBulkAssignTeamModal();
            deselectAllUsers();
            refreshUsersTable();
            refreshTeamsTable();
            refreshDashboard();
            autoSave();
            
            log(`✅ Bulk assigned ${successCount} users to team ${team.name}`);
            alert(`Successfully assigned ${successCount} users to team ${team.name}!`);
        }

        function bulkExportUsers() {
            if (bulkSelection.users.size === 0) {
                alert('Please select users first');
                return;
            }
            
            const exportData = {
                title: 'Selected Users Export',
                exportDate: new Date().toISOString(),
                users: Array.from(bulkSelection.users).map(email => {
                    const user = appData.users.get(email);
                    return {
                        email: user.email,
                        name: user.name,
                        currentMonthPoints: user.currentMonthPoints,
                        totalPoints: user.totalPoints,
                        activities: user.activities?.length || 0,
                        teamId: user.teamId,
                        lastActivity: user.lastActivity
                    };
                })
            };
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            downloadJSON(exportData, `selected_users_${timestamp}.json`);
            
            log(`📥 Exported ${bulkSelection.users.size} selected users`);
        }

        // Sort toggle functions for Users
        function toggleUserSort(field) {
            if (sortState.users.field === field) {
                // Same field, toggle order
                sortState.users.ascending = !sortState.users.ascending;
            } else {
                // Different field, set new field and default to descending (most first)
                sortState.users.field = field;
                sortState.users.ascending = false;
            }
            refreshUsersTable();
        }

        function toggleUserSortOrder() {
            sortState.users.ascending = !sortState.users.ascending;
            refreshUsersTable();
        }

        function updateUserSortButtons() {
            // Reset all buttons
            ['sortCurrentMonth', 'sortTotal'].forEach(id => {
                const btn = document.getElementById(id);
                btn.className = 'px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors';
            });
            
            // Highlight active field
            const activeField = sortState.users.field === 'currentMonthPoints' ? 'sortCurrentMonth' : 'sortTotal';
            const activeBtn = document.getElementById(activeField);
            activeBtn.className = 'px-3 py-1 text-xs rounded-lg bg-blue-100 text-blue-800 border border-blue-300';
            
            // Update sort order button
            const orderBtn = document.getElementById('sortOrderUser');
            orderBtn.textContent = sortState.users.ascending ? 'Least First ⬆️' : 'Most First ⬇️';
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function refreshActivitiesTable() {
            const tbody = document.getElementById('activitiesTableBody');
            let activities = [...appData.activities];
            
            // Apply sorting
            activities.sort((a, b) => {
                let aValue, bValue;
                
                if (sortState.activities.field === 'pointsEarned') {
                    aValue = a.pointsEarned;
                    bValue = b.pointsEarned;
                } else if (sortState.activities.field === 'completedDate') {
                    aValue = new Date(a.completedDate);
                    bValue = new Date(b.completedDate);
                }
                
                if (sortState.activities.ascending) {
                    return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                } else {
                    return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                }
            });
            
            tbody.innerHTML = activities.map(activity => {
                const user = appData.users.get(activity.userEmail);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <input type="checkbox" 
                                   class="activity-checkbox rounded" 
                                   value="${activity.id}"
                                   onchange="toggleActivitySelection('${activity.id}')"
                                   ${bulkSelection.activities.has(activity.id) ? 'checked' : ''}>
                        </td>
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${user?.name || activity.userEmail}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${activity.title}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-sm text-gray-600">${activity.courseType}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                activity.level === 'fundamental' ? 'bg-green-100 text-green-800' :
                                activity.level === 'intermediate' ? 'bg-blue-100 text-blue-800' :
                                activity.level === 'advanced' ? 'bg-purple-100 text-purple-800' :
                                'bg-gray-100 text-gray-800'
                            }">${activity.level}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-bold text-purple-600">${activity.pointsEarned}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-sm text-gray-500">${formatDate(activity.completedDate)}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-xs text-gray-500">${activity.source}</span>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="editActivity('${activity.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateActivitySortButtons();
            updateBulkSelectionUI('activities');
        }

        // Bulk selection functions for Activities
        function toggleActivitySelection(activityId) {
            if (bulkSelection.activities.has(activityId)) {
                bulkSelection.activities.delete(activityId);
            } else {
                bulkSelection.activities.add(activityId);
            }
            updateBulkSelectionUI('activities');
        }

        function toggleSelectAllActivities() {
            const checkbox = document.getElementById('selectAllActivitiesCheckbox');
            const activityCheckboxes = document.querySelectorAll('.activity-checkbox');
            
            if (checkbox.checked) {
                activityCheckboxes.forEach(cb => {
                    cb.checked = true;
                    bulkSelection.activities.add(cb.value);
                });
            } else {
                activityCheckboxes.forEach(cb => {
                    cb.checked = false;
                });
                bulkSelection.activities.clear();
            }
            updateBulkSelectionUI('activities');
        }

        function selectAllActivities() {
            const activityCheckboxes = document.querySelectorAll('.activity-checkbox');
            activityCheckboxes.forEach(cb => {
                cb.checked = true;
                bulkSelection.activities.add(cb.value);
            });
            document.getElementById('selectAllActivitiesCheckbox').checked = true;
            updateBulkSelectionUI('activities');
        }

        function deselectAllActivities() {
            const activityCheckboxes = document.querySelectorAll('.activity-checkbox');
            activityCheckboxes.forEach(cb => {
                cb.checked = false;
            });
            bulkSelection.activities.clear();
            document.getElementById('selectAllActivitiesCheckbox').checked = false;
            updateBulkSelectionUI('activities');
        }

        // Bulk operations for Activities
        function bulkAdjustPoints() {
            if (bulkSelection.activities.size === 0) {
                alert('Please select activities first');
                return;
            }
            
            document.getElementById('bulkAdjustActivityCount').textContent = bulkSelection.activities.size;
            document.getElementById('bulkAdjustPointsModal').classList.remove('hidden');
        }

        function closeBulkAdjustPointsModal() {
            document.getElementById('bulkAdjustPointsModal').classList.add('hidden');
            document.getElementById('bulkAdjustType').value = 'add';
            document.getElementById('bulkAdjustValue').value = '';
            document.getElementById('bulkAdjustReason').value = '';
        }

        function submitBulkAdjustPoints() {
            const adjustType = document.getElementById('bulkAdjustType').value;
            const value = parseFloat(document.getElementById('bulkAdjustValue').value);
            const reason = document.getElementById('bulkAdjustReason').value.trim();

            if (!value || isNaN(value)) {
                alert('Please enter a valid value');
                return;
            }

            let successCount = 0;
            const affectedUsers = new Set();

            bulkSelection.activities.forEach(activityId => {
                const activity = appData.activities.find(a => a.id === activityId);
                if (activity) {
                    const oldPoints = activity.pointsEarned;
                    let newPoints = oldPoints;

                    switch(adjustType) {
                        case 'add':
                            newPoints = oldPoints + value;
                            break;
                        case 'subtract':
                            newPoints = Math.max(0, oldPoints - value);
                            break;
                        case 'multiply':
                            newPoints = Math.round(oldPoints * value);
                            break;
                        case 'set':
                            newPoints = value;
                            break;
                    }

                    const pointDiff = newPoints - oldPoints;
                    activity.pointsEarned = newPoints;
                    activity.adjustmentHistory = activity.adjustmentHistory || [];
                    activity.adjustmentHistory.push({
                        date: new Date().toISOString(),
                        type: adjustType,
                        value: value,
                        oldPoints: oldPoints,
                        newPoints: newPoints,
                        reason: reason
                    });

                    // Update user's points
                    const user = appData.users.get(activity.userEmail);
                    if (user) {
                        user.totalPoints += pointDiff;
                        if (activity.monthYear === getCurrentMonth()) {
                            user.currentMonthPoints += pointDiff;
                        }
                        affectedUsers.add(activity.userEmail);
                    }

                    successCount++;
                }
            });

            // Update team points for affected users
            affectedUsers.forEach(email => {
                const user = appData.users.get(email);
                if (user && user.teamId) {
                    updateTeamPoints(user.teamId);
                }
            });

            closeBulkAdjustPointsModal();
            deselectAllActivities();
            refreshDashboard();
            refreshActivitiesTable();
            refreshUsersTable();
            refreshTeamsTable();
            autoSave();

            log(`✅ Bulk adjusted points for ${successCount} activities (${adjustType} ${value})`);
            alert(`Successfully adjusted points for ${successCount} activities!`);
        }

        function bulkDeleteActivities() {
            if (bulkSelection.activities.size === 0) {
                alert('Please select activities first');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${bulkSelection.activities.size} activities? This cannot be undone.`)) {
                return;
            }

            const affectedUsers = new Set();
            let successCount = 0;

            bulkSelection.activities.forEach(activityId => {
                const activityIndex = appData.activities.findIndex(a => a.id === activityId);
                if (activityIndex !== -1) {
                    const activity = appData.activities[activityIndex];
                    
                    // Update user's points
                    const user = appData.users.get(activity.userEmail);
                    if (user) {
                        user.totalPoints -= activity.pointsEarned;
                        if (activity.monthYear === getCurrentMonth()) {
                            user.currentMonthPoints -= activity.pointsEarned;
                        }
                        // Remove activity from user's list
                        user.activities = user.activities.filter(id => id !== activityId);
                        affectedUsers.add(activity.userEmail);
                    }

                    // Remove the activity
                    appData.activities.splice(activityIndex, 1);
                    successCount++;
                }
            });

            // Update team points for affected users
            affectedUsers.forEach(email => {
                const user = appData.users.get(email);
                if (user && user.teamId) {
                    updateTeamPoints(user.teamId);
                }
            });

            deselectAllActivities();
            refreshDashboard();
            refreshActivitiesTable();
            refreshUsersTable();
            refreshTeamsTable();
            autoSave();

            log(`🗑️ Bulk deleted ${successCount} activities`);
            alert(`Successfully deleted ${successCount} activities!`);
        }

        function bulkExportActivities() {
            if (bulkSelection.activities.size === 0) {
                alert('Please select activities first');
                return;
            }

            const exportData = {
                title: 'Selected Activities Export',
                exportDate: new Date().toISOString(),
                activities: Array.from(bulkSelection.activities).map(activityId => {
                    const activity = appData.activities.find(a => a.id === activityId);
                    const user = appData.users.get(activity.userEmail);
                    return {
                        user: user?.name || activity.userEmail,
                        email: activity.userEmail,
                        activity: activity.title,
                        courseType: activity.courseType,
                        level: activity.level,
                        points: activity.pointsEarned,
                        completedDate: activity.completedDate,
                        source: activity.source,
                        adjustmentHistory: activity.adjustmentHistory
                    };
                })
            };

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            downloadJSON(exportData, `selected_activities_${timestamp}.json`);

            log(`📥 Exported ${bulkSelection.activities.size} selected activities`);
        }

        // Sort toggle functions for Activities
        function toggleActivitySort(field) {
            if (sortState.activities.field === field) {
                // Same field, toggle order
                sortState.activities.ascending = !sortState.activities.ascending;
            } else {
                // Different field, set new field and default to descending (most/recent first)
                sortState.activities.field = field;
                sortState.activities.ascending = false;
            }
            refreshActivitiesTable();
        }

        function toggleActivitySortOrder() {
            sortState.activities.ascending = !sortState.activities.ascending;
            refreshActivitiesTable();
        }

        function updateActivitySortButtons() {
            // Reset all buttons
            ['sortPoints', 'sortDate'].forEach(id => {
                const btn = document.getElementById(id);
                btn.className = 'px-3 py-1 text-xs rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors';
            });
            
            // Highlight active field
            const activeField = sortState.activities.field === 'pointsEarned' ? 'sortPoints' : 'sortDate';
            const activeBtn = document.getElementById(activeField);
            activeBtn.className = 'px-3 py-1 text-xs rounded-lg bg-blue-100 text-blue-800 border border-blue-300';
            
            // Update sort order button
            const orderBtn = document.getElementById('sortOrderActivity');
            if (sortState.activities.field === 'pointsEarned') {
                orderBtn.textContent = sortState.activities.ascending ? 'Least First ⬆️' : 'Most First ⬇️';
            } else {
                orderBtn.textContent = sortState.activities.ascending ? 'Oldest First ⬆️' : 'Recent First ⬇️';
            }
        }

        function filterActivities() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const filter = document.getElementById('activityFilter').value;
            const currentMonth = getCurrentMonth();
            const rows = document.querySelectorAll('#activitiesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const activityId = row.querySelector('button').onclick.toString().match(/'([^']+)'/)[1];
                const activity = appData.activities.find(a => a.id === activityId);
                
                let showRow = text.includes(searchTerm);
                
                if (showRow && filter !== 'all') {
                    switch(filter) {
                        case 'current-month':
                            showRow = activity?.monthYear === currentMonth;
                            break;
                        case 'courses':
                            showRow = !activity?.courseType?.includes('Meeting');
                            break;
                        case 'events':
                            showRow = activity?.courseType?.includes('Meeting') || activity?.level === 'live_event';
                            break;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        // Modal functions
        function addManualPoints() {
            document.getElementById('addPointsModal').classList.remove('hidden');
        }

        function closeAddPointsModal() {
            document.getElementById('addPointsModal').classList.add('hidden');
            // Clear form
            document.getElementById('manualUserEmail').value = '';
            document.getElementById('manualActivityTitle').value = '';
            document.getElementById('manualPoints').value = '';
            document.getElementById('manualDescription').value = '';
        }

        function submitManualPoints() {
            const email = document.getElementById('manualUserEmail').value.trim().toLowerCase();
            const title = document.getElementById('manualActivityTitle').value.trim();
            const points = parseInt(document.getElementById('manualPoints').value);
            const description = document.getElementById('manualDescription').value.trim();

            if (!email || !title || !points) {
                alert('Please fill in all required fields');
                return;
            }

            // Create manual activity
            const activity = {
                id: `manual_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                userEmail: email,
                courseId: `manual_${Date.now()}`,
                title: title,
                level: 'manual',
                courseType: 'Manual Award',
                pointsEarned: points,
                completedDate: new Date().toISOString(),
                score: null,
                source: 'manual_entry',
                importDate: new Date().toISOString(),
                monthYear: getCurrentMonth(),
                description: description
            };

            appData.activities.push(activity);

            // Update or create user
            if (!appData.users.has(email)) {
                appData.users.set(email, {
                    email: email,
                    name: email.split('@')[0],
                    firstName: '',
                    lastName: '',
                    currentMonthPoints: 0,
                    totalPoints: 0,
                    activities: [],
                    joinDate: new Date().toISOString(),
                    lastActivity: new Date().toISOString()
                });
            }

            const user = appData.users.get(email);
            user.activities = user.activities || [];
            user.activities.push(activity.id);
            user.totalPoints += points;
            user.currentMonthPoints += points;
            user.lastActivity = new Date().toISOString();

            closeAddPointsModal();
            refreshDashboard();
            refreshUsersTable();
            refreshActivitiesTable();
            autoSave(); // Auto-save after manual points

            log(`✅ Manual points awarded: ${points} to ${email} for "${title}"`);
        }

        // Report functions
        function generateLeaderboardReport() {
            const currentMonth = getCurrentMonth();
            const leaderboard = Array.from(appData.users.values())
                .filter(user => user.currentMonthPoints > 0)
                .sort((a, b) => b.currentMonthPoints - a.currentMonthPoints);

            const reportData = {
                title: `Leaderboard Report - ${currentMonth}`,
                generated: new Date().toISOString(),
                data: leaderboard.map((user, index) => ({
                    rank: index + 1,
                    name: user.name,
                    email: user.email,
                    currentMonthPoints: user.currentMonthPoints,
                    totalPoints: user.totalPoints,
                    activities: user.activities?.length || 0
                }))
            };

            downloadJSON(reportData, `cloud_comp_leaderboard_${currentMonth}.json`);
        }

        function generateActivityReport() {
            const reportData = {
                title: 'Activity Report',
                generated: new Date().toISOString(),
                data: appData.activities.map(activity => {
                    const user = appData.users.get(activity.userEmail);
                    return {
                        user: user?.name || activity.userEmail,
                        email: activity.userEmail,
                        activity: activity.title,
                        courseType: activity.courseType,
                        level: activity.level,
                        points: activity.pointsEarned,
                        completedDate: activity.completedDate,
                        source: activity.source
                    };
                })
            };

            downloadJSON(reportData, `cloud_comp_activities_${new Date().toISOString().slice(0, 10)}.json`);
        }

        function generateSummaryReport() {
            const currentMonth = getCurrentMonth();
            const reportData = {
                title: 'Summary Report',
                generated: new Date().toISOString(),
                summary: {
                    totalUsers: appData.users.size,
                    totalTeams: appData.teams.size,
                    totalActivities: appData.activities.length,
                    totalPoints: Array.from(appData.users.values()).reduce((sum, user) => sum + user.totalPoints, 0),
                    currentMonthActivities: appData.activities.filter(a => a.monthYear === currentMonth).length,
                    currentMonthPoints: Array.from(appData.users.values()).reduce((sum, user) => sum + user.currentMonthPoints, 0),
                    lastImport: appData.metadata.lastImport,
                    sources: appData.metadata.sources
                },
                topUsers: Array.from(appData.users.values())
                    .sort((a, b) => b.currentMonthPoints - a.currentMonthPoints)
                    .slice(0, 10)
                    .map(user => ({
                        name: user.name,
                        email: user.email,
                        currentMonthPoints: user.currentMonthPoints,
                        totalPoints: user.totalPoints
                    })),
                topTeams: Array.from(appData.teams.values())
                    .sort((a, b) => b.currentMonthPoints - a.currentMonthPoints)
                    .slice(0, 5)
                    .map(team => ({
                        name: team.name,
                        members: team.members.length,
                        currentMonthPoints: team.currentMonthPoints,
                        totalPoints: team.totalPoints
                    }))
            };

            downloadJSON(reportData, `cloud_comp_summary_${new Date().toISOString().slice(0, 10)}.json`);
        }

        function resetMonthlyLeaderboard() {
            if (!confirm('Are you sure you want to reset the monthly leaderboard? This will set all current month points to 0.')) {
                return;
            }

            // Archive current month
            const currentMonth = getCurrentMonth();
            const archiveData = {
                month: currentMonth,
                resetDate: new Date().toISOString(),
                leaderboard: Array.from(appData.users.values())
                    .filter(user => user.currentMonthPoints > 0)
                    .sort((a, b) => b.currentMonthPoints - a.currentMonthPoints)
                    .map(user => ({
                        name: user.name,
                        email: user.email,
                        points: user.currentMonthPoints
                    }))
            };

            downloadJSON(archiveData, `cloud_comp_leaderboard_archive_${currentMonth}.json`);

            // Reset all users' current month points
            appData.users.forEach(user => {
                user.currentMonthPoints = 0;
            });

            // Update config
            appData.config.lastReset = currentMonth;

            refreshDashboard();
            refreshUsersTable();
            autoSave(); // Auto-save after reset

            log(`🔄 Monthly leaderboard reset for ${currentMonth}`);
        }

        function confirmMonthlyReset() {
            resetMonthlyLeaderboard();
        }

        function viewUserDetails(email) {
            // Placeholder for user detail view
            alert(`User details for ${email} - Feature coming soon!`);
        }

        function editActivity(activityId) {
            // Placeholder for activity editing
            alert(`Edit activity ${activityId} - Feature coming soon!`);
        }

        // File input handlers
        document.getElementById('courseFiles').addEventListener('change', function(e) {
            selectedFiles.course = Array.from(e.target.files);
            updateFileList('course', selectedFiles.course);
        });

        document.getElementById('teamsFiles').addEventListener('change', function(e) {
            selectedFiles.teams = Array.from(e.target.files);
            updateFileList('teams', selectedFiles.teams);
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            log('☁️ Cloud Comp Admin initialized');
            loadData();
            
            // Initialize sort button states
            setTimeout(() => {
                updateUserSortButtons();
                updateActivitySortButtons();
                updateTeamSortButtons();
            }, 100);
        });
    </script>